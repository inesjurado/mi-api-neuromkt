@page "/investProyecto"
@using NeuromktApi.Models
@using NeuromktApi.Services
@using Npgsql
@inject UserSession UserSession
@inject IEProyecto EProyecto
@inject IEPrueba EPrueba
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject IExportService ExportService

<RadzenCard Class="nf-page" Style="border:none; box-shadow:none;">

    <!-- Cabecera -->
    <div class="nf-header">
        <RadzenCard Class="nf-title-card">
            <div class="nf-title-text">
                PROYECTOS
            </div>
        </RadzenCard>
    </div>

    <RadzenCard Class="nf-table-card" Style="margin-top:2rem;">

        <div class="nf-toolbar">
            <RadzenButton Icon="add_circle"
                          Text="Nuevo proyecto"
                          ButtonStyle="ButtonStyle.Primary"
                          Disabled="@busy"
                          Click="@NuevoProyecto" />

            <RadzenButton Icon="file_download"
                          Text="Descargar Proyectos"
                          ButtonStyle="ButtonStyle.Secondary"
                          Disabled="@(!proyectos.Any())"
                          Click="@DescargarProyectos" />
        </div>

        @if (!string.IsNullOrEmpty(mensajeOk))
        {
            <RadzenAlert Severity="AlertSeverity.Success"
                         Style="margin-bottom:0.75rem;">
                @mensajeOk
            </RadzenAlert>
        }

        @if (!string.IsNullOrEmpty(mensajeError))
        {
            <RadzenAlert Severity="AlertSeverity.Error"
                         Style="margin-bottom:0.75rem;">
                @mensajeError
            </RadzenAlert>
        }

        <RadzenDataGrid TItem="ProyectoModel"
                        Data="@proyectos"
                        RowHover="true"
                        AllowPaging="true"
                        PageSize="10"
                        ShowPagingSummary="true"
                        AllowSorting="true"
                        AllowFiltering="true"
                        FilterMode="FilterMode.Advanced"
                        Style="width:100%;">
            <Columns>
                <RadzenDataGridColumn TItem="ProyectoModel"
                                      Property="Codigo"
                                      Title="Código"
                                      Width="120px"
                                      Filterable="true" />

                <RadzenDataGridColumn TItem="ProyectoModel"
                                      Property="Nombre"
                                      Title="Proyecto"
                                      Filterable="true"
                                      FilterOperator="FilterOperator.Contains" />

                <RadzenDataGridColumn TItem="ProyectoModel"
                                      Property="NumParticipantes"
                                      Title="Participantes"
                                      Width="140px"
                                      Filterable="false" />

                <RadzenDataGridColumn TItem="ProyectoModel"
                                      Title="Acciones"
                                      Width="200px"
                                      Filterable="false">
                    <Template Context="p">
                        <RadzenButton Icon="edit"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Light"
                                      Style="margin-right:0.5rem;"
                                      Click="@(() => VerProyecto(p))" />

                        <RadzenButton Icon="play_arrow"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Light"
                                      Style="margin-right:0.5rem;"
                                      Click="@(() => AbrirDialogoEmpezar(p))" />

                        <RadzenButton Icon="delete"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@(() => BorrarProyecto(p))" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>

    </RadzenCard>

</RadzenCard>

@if (empezarDialogVisible)
{
    <div class="nf-modal-backdrop">
        <RadzenCard Class="nf-modal-card">
            <div class="nf-modal-header">
                <span>
                    Empezar prueba
                    @if (proyectoSeleccionado != null)
                    {
                        <text> – @proyectoSeleccionado.Nombre</text>
                    }
                </span>
                <button type="button"
                        class="nf-modal-close"
                        @onclick="CerrarDialogoEmpezar">
                    ✕
                </button>
            </div>

            <div class="nf-dialog-form">
                <div class="nf-form-field">
                    <label>Participante</label>
                    <RadzenDropDown Data="@pruebasProyecto"
                                    TextProperty="ParticipanteEmail"
                                    ValueProperty="Codigo"
                                    @bind-Value="pruebaSeleccionadaCodigo"
                                    Style="width:100%;"
                                    Placeholder="Selecciona un participante" />

                    @if (!string.IsNullOrEmpty(dialogError))
                    {
                        <div class="nf-input-error">@dialogError</div>
                    }
                </div>

                <div class="nf-form-actions">
                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="play_arrow"
                                  Disabled="@(!PuedeConfirmarEmpezar)"
                                  Click="@ConfirmarEmpezarPrueba"
                                  Text="Empezar" />

                    <RadzenButton ButtonStyle="ButtonStyle.Light"
                                  Text="Cancelar"
                                  Icon="close"
                                  Click="@CerrarDialogoEmpezar"
                                  Style="margin-left:0.5rem;" />
                </div>
            </div>
        </RadzenCard>
    </div>
}

@code {
    private List<ProyectoModel> proyectos = new();
    private bool busy = false;
    private string? mensajeOk;
    private string? mensajeError;

    // Modal empezar
    private bool empezarDialogVisible = false;
    private ProyectoModel? proyectoSeleccionado;
    private List<PruebaModel> pruebasProyecto = new();
    private string? pruebaSeleccionadaCodigo; // aquí guardo PRB<n>
    private string? dialogError;
    private bool empezarBusy = false;

    private bool PuedeConfirmarEmpezar =>
        !string.IsNullOrEmpty(pruebaSeleccionadaCodigo) && !empezarBusy;

    protected override async Task OnInitializedAsync()
    {
        await CargarProyectosAsync();
    }

    private async Task CargarProyectosAsync()
    {
        try
        {
            mensajeError = null;
            var emailActual = UserSession.Email;
            if (string.IsNullOrWhiteSpace(emailActual))
            {
                mensajeError = "No se ha podido obtener el usuario actual. Vuelve a iniciar sesión.";
                return;
            }
            proyectos = await EProyecto.ListarProyectosPorCreadorAsync(emailActual);
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando proyectos: " + ex.Message;
        }
    }

    private void NuevoProyecto()
    {
        Nav.NavigateTo("/nuevoProyecto");
    }

    private void VerProyecto(ProyectoModel p)
    {
        Nav.NavigateTo($"/nuevoProyecto/{p.Codigo}");
    }

    private async Task BorrarProyecto(ProyectoModel p)
    {
        if (busy) return;

        var confirmar = await JS.InvokeAsync<bool>(
            "confirm", $"¿Seguro que quieres eliminar el proyecto '{p.Nombre}'?");

        if (!confirmar) return;

        mensajeOk = null;
        mensajeError = null;
        busy = true;

        try
        {
            await EProyecto.EliminarProyectoAsync(p.Codigo);
            mensajeOk = "Proyecto eliminado correctamente.";
            await CargarProyectosAsync();
        }
        catch (PostgresException ex)
        {
            mensajeError = ex.MessageText;
        }
        catch (Exception ex)
        {
            mensajeError = "Error inesperado: " + ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    private async Task AbrirDialogoEmpezar(ProyectoModel p)
    {
        if (busy) return;

        dialogError = null;
        proyectoSeleccionado = p;
        pruebasProyecto = new List<PruebaModel>();
        pruebaSeleccionadaCodigo = null;

        try
        {
            // ✅ Esto debe devolver ParticipanteEmail (para mostrar)
            //    y ParticipanteCodigo (para navegar)
            pruebasProyecto = await EPrueba.ListarPruebasPorProyectoAsync(p.Codigo);
            empezarDialogVisible = true;
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando participantes del proyecto: " + ex.Message;
        }
    }

    private void CerrarDialogoEmpezar()
    {
        empezarDialogVisible = false;
        proyectoSeleccionado = null;
        pruebasProyecto = new();
        pruebaSeleccionadaCodigo = null;
        dialogError = null;
        empezarBusy = false;
    }

    private async Task ConfirmarEmpezarPrueba()
    {
        dialogError = null;

        if (string.IsNullOrWhiteSpace(pruebaSeleccionadaCodigo))
        {
            dialogError = "Selecciona un participante.";
            return;
        }

        if (proyectoSeleccionado == null)
        {
            dialogError = "No se ha podido obtener el proyecto.";
            return;
        }

        var prueba = pruebasProyecto
            .FirstOrDefault(x => x.Codigo == pruebaSeleccionadaCodigo);

        if (prueba == null)
        {
            dialogError = "No se ha encontrado la prueba seleccionada.";
            return;
        }

        if (string.IsNullOrWhiteSpace(prueba.ParticipanteCodigo))
        {
            dialogError = "La prueba no tiene participante asociado (código vacío).";
            return;
        }

        empezarBusy = true;

        try
        {
            await EPrueba.ActualizarFechaPruebaAsync(prueba.Codigo);

            var participanteEncoded = Uri.EscapeDataString(prueba.ParticipanteCodigo);
            var pruebaEncoded = Uri.EscapeDataString(prueba.Codigo);

            Nav.NavigateTo(
                $"/prueba/{proyectoSeleccionado.Codigo}/{participanteEncoded}?pruebaCodigo={pruebaEncoded}"
            );
        }
        catch (Exception ex)
        {
            dialogError = "Error al empezar la prueba: " + ex.Message;
        }
        finally
        {
            empezarBusy = false;
        }
    }

    private async Task DescargarProyectos()
    {
        try
        {
            await ExportService.DescargarCsvAsync(proyectos, "proyectos.csv");
        }
        catch (Exception ex)
        {
            mensajeError = "Error al descargar los proyectos: " + ex.Message;
        }
    }
}
