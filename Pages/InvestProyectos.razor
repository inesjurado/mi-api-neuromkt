@page "/investProyecto"

@using NeuromktApi.Models
@using NeuromktApi.Services
@using Npgsql
@using System.Linq

@inject UserSession UserSession
@inject IEProyecto EProyecto
@inject IEPrueba EPrueba
@inject IEParticipante EParticipante
@inject IEFragancia EFragancia
@inject IEProyectoFragancia EProyectoFragancia
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject IExportService ExportService

<RadzenCard Class="nf-page" Style="border:none; box-shadow:none;">

    <div class="nf-header">
        <RadzenCard Class="nf-title-card">
            <div class="nf-title-text">
                PROYECTOS
            </div>
        </RadzenCard>
    </div>

    <RadzenCard Class="nf-table-card" Style="margin-top:2rem;">

        <div class="nf-toolbar">
            <RadzenButton Icon="add_circle"
                          Text="Nuevo proyecto"
                          ButtonStyle="ButtonStyle.Primary"
                          Disabled="@busy"
                          Click="@NuevoProyecto" />

            <RadzenButton Icon="file_download"
                          Text="Descargar Proyectos"
                          ButtonStyle="ButtonStyle.Secondary"
                          Disabled="@(!proyectos.Any())"
                          Click="@DescargarProyectos" />
        </div>

        @if (!string.IsNullOrEmpty(mensajeOk))
        {
            <RadzenAlert Severity="AlertSeverity.Success" Style="margin-bottom:0.75rem;">
                @mensajeOk
            </RadzenAlert>
        }

        @if (!string.IsNullOrEmpty(mensajeError))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Style="margin-bottom:0.75rem;">
                @mensajeError
            </RadzenAlert>
        }

        <RadzenDataGrid TItem="ProyectoModel"
                        Data="@proyectos"
                        RowHover="true"
                        AllowPaging="true"
                        PageSize="10"
                        ShowPagingSummary="true"
                        AllowSorting="true"
                        AllowFiltering="true"
                        FilterMode="FilterMode.Advanced"
                        Style="width:100%;">
            <Columns>
                <RadzenDataGridColumn TItem="ProyectoModel"
                                      Property="Codigo"
                                      Title="Código"
                                      Width="120px"
                                      Filterable="true" />

                <RadzenDataGridColumn TItem="ProyectoModel"
                                      Property="Nombre"
                                      Title="Proyecto"
                                      Filterable="true"
                                      FilterOperator="FilterOperator.Contains" />

                <RadzenDataGridColumn TItem="ProyectoModel"
                                      Property="NumParticipantes"
                                      Title="Participantes"
                                      Width="140px"
                                      Filterable="false" />

                <RadzenDataGridColumn TItem="ProyectoModel"
                                    Property="Proveedor"
                                    Title="Proveedor"
                                    Filterable="true"
                                    FilterOperator="FilterOperator.Contains" />

                <RadzenDataGridColumn TItem="ProyectoModel"
                                    Property="Descripcion"
                                    Title="Descripción"
                                    Filterable="true"
                                    FilterOperator="FilterOperator.Contains" />

                <RadzenDataGridColumn TItem="ProyectoModel"
                                    Property="FechaCreacion"
                                    Title="Fecha creación"
                                    Type="typeof(DateTime)"
                                    FormatString="{0:dd/MM/yyyy}"
                                    Filterable="true" />

                <RadzenDataGridColumn TItem="ProyectoModel"
                                      Title="Acciones"
                                      Width="220px"
                                      Filterable="false">
                    <Template Context="p">
                        <RadzenButton Icon="edit"
                                      Title="Editar proyecto"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Light"
                                      Style="margin-right:0.5rem;"
                                      Click="@(() => VerProyecto(p))" />

                        <RadzenButton Icon="play_arrow"
                                      Title="Empezar prueba"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Light"
                                      Style="margin-right:0.5rem;"
                                      Click="@(() => AbrirDialogoEmpezar(p))" />

                        <RadzenButton Icon="analytics"
                                      Title="Ver resultados"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Light"
                                      Style="margin-right:0.5rem;"
                                      Click="@(() => AbrirDialogoResultados(p))" />

                        <RadzenButton Icon="file_download"
                                      Title="Descargar proyecto"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Light"
                                      Style="margin-right:0.5rem;"
                                      Click="@(() => DescargarProyecto(p))" />

                        <RadzenButton Icon="delete"
                                      Title="Eliminar proyecto"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@(() => BorrarProyecto(p))" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>

    </RadzenCard>

</RadzenCard>

@if (empezarDialogVisible)
{
    <div class="nf-modal-backdrop">
        <RadzenCard Class="nf-modal-card">
            <div class="nf-modal-header">
                <span>
                    Empezar prueba
                    @if (proyectoSeleccionado != null)
                    {
                        <text> – @proyectoSeleccionado.Nombre</text>
                    }
                </span>
                <button type="button"
                        class="nf-modal-close"
                        @onclick="CerrarDialogoEmpezar">
                    ✕
                </button>
            </div>

            <div class="nf-dialog-form">

                @if ((fraganciasProyecto?.Count ?? 0) > 1)
                {
                    <div class="nf-form-field">
                        <label>Fragancia</label>

                        <RadzenDropDown Data="@fraganciasProyecto"
                                        TextProperty="Nombre"
                                        ValueProperty="Codigo"
                                        @bind-Value="fraganciaSeleccionadaCodigo"
                                        Change="@OnFraganciaCambiada"
                                        Style="width:100%;"
                                        Placeholder="Selecciona la fragancia a usar" />

                    </div>
                }
                else if ((fraganciasProyecto?.Count ?? 0) == 1)
                {
                    <div class="nf-form-field">
                        <label>Fragancia</label>
                        <div style="
                            padding:0.6rem 0.75rem;
                            border:1px solid #d1d5db;
                            border-radius:6px;
                            background:#f9fafb;
                            color:#111827;
                            font-weight:500;
                        ">
                            @fraganciasProyecto[0].Nombre
                        </div>
                    </div>
                }
                else
                {
                    <div class="nf-form-field">
                        <div class="nf-input-error">
                            Este proyecto no tiene fragancias asociadas.
                        </div>
                    </div>
                }

                <div class="nf-form-field">
                    <label>Participante</label>

                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <RadzenDropDown Data="@participantesDisponibles"
                                        TextProperty="Email"
                                        ValueProperty="Email"
                                        @bind-Value="participanteSeleccionadoEmail"
                                        Style="flex:1;"
                                        Placeholder="Selecciona un participante disponible" />

                        <RadzenButton Icon="add_circle"
                                      Text="Añadir"
                                      ButtonStyle="ButtonStyle.Secondary"
                                      Click="@AbrirPopupNuevoParticipante" />
                    </div>

                    @if (participantesDisponibles != null && participantesDisponibles.Count == 0)
                    {
                        <div class="nf-input-error" style="margin-top:0.5rem;">
                            No hay participantes disponibles para esta fragancia.
                        </div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(dialogError))
                {
                    <div class="nf-input-error">@dialogError</div>
                }

                <div class="nf-form-actions">
                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="play_arrow"
                                  Disabled="@(!PuedeConfirmarEmpezar)"
                                  Click="@ConfirmarEmpezarPrueba"
                                  Text="Empezar" />

                    <RadzenButton ButtonStyle="ButtonStyle.Light"
                                  Text="Cancelar"
                                  Icon="close"
                                  Click="@CerrarDialogoEmpezar"
                                  Style="margin-left:0.5rem;" />
                </div>
            </div>
        </RadzenCard>
    </div>
}

<NuevoParticipante Visible="@dialogoParticipanteVisible"
                   VisibleChanged="@(v => dialogoParticipanteVisible = v)"
                   EsEdicion="false"
                   OnGuardado="@OnParticipanteCreado" />

<ResultadosDialog Visible="@resultadosDialogVisible"
                  VisibleChanged="@(v => resultadosDialogVisible = v)"
                  Proyecto="@proyectoSeleccionado"
                  ReturnUrl="/investProyecto" />

@code {
    private List<ProyectoModel> proyectos = new();
    private bool busy = false;
    private string? mensajeOk;
    private string? mensajeError;

    private bool empezarDialogVisible = false;
    private ProyectoModel? proyectoSeleccionado;

    private bool resultadosDialogVisible = false;

    // Participantes disponibles 
    private List<ParticipanteModel> participantesDisponibles = new();
    private string? participanteSeleccionadoEmail;

    // Fragancias del proyecto
    private List<FraganciaModel> fraganciasProyecto = new();
    private string? fraganciaSeleccionadaCodigo;

    private string? dialogError;
    private bool empezarBusy = false;

    private bool dialogoParticipanteVisible = false;

    private void NuevoProyecto() => Nav.NavigateTo("/nuevoProyecto");
    private void VerProyecto(ProyectoModel p) => Nav.NavigateTo($"/nuevoProyecto/{p.Codigo}");

    private bool PuedeConfirmarEmpezar
    {
        get
        {
            if (empezarBusy) return false;
            if (proyectoSeleccionado == null) return false;

            if ((fraganciasProyecto?.Count ?? 0) == 0) return false;
            if (fraganciasProyecto.Count > 1 && string.IsNullOrWhiteSpace(fraganciaSeleccionadaCodigo)) return false;

            if (string.IsNullOrWhiteSpace(participanteSeleccionadoEmail)) return false;
            if ((participantesDisponibles?.Count ?? 0) == 0) return false;

            return true;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarProyectosAsync();
    }

    private async Task CargarProyectosAsync()
    {
        try
        {
            mensajeError = null;

            var emailActual = UserSession.Email;
            if (string.IsNullOrWhiteSpace(emailActual))
            {
                mensajeError = "No se ha podido obtener el usuario actual. Vuelve a iniciar sesión.";
                return;
            }

            proyectos = await EProyecto.ListarProyectosPorCreadorAsync(emailActual.Trim().ToLower());
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando proyectos: " + ex.Message;
        }
    }

    private async Task BorrarProyecto(ProyectoModel p)
    {
        if (busy) return;

        var confirmar = await JS.InvokeAsync<bool>("confirm", $"¿Seguro que quieres eliminar el proyecto '{p.Nombre}'?");
        if (!confirmar) return;

        mensajeOk = null;
        mensajeError = null;
        busy = true;

        try
        {
            await EProyecto.EliminarProyectoAsync(p.Codigo);
            mensajeOk = "Proyecto eliminado correctamente.";
            await CargarProyectosAsync();
        }
        catch (PostgresException ex)
        {
            mensajeError = ex.MessageText;
        }
        catch (Exception ex)
        {
            mensajeError = "Error inesperado: " + ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    private async Task AbrirDialogoEmpezar(ProyectoModel p)
    {
        if (busy) return;

        dialogError = null;
        proyectoSeleccionado = p;

        participantesDisponibles = new();
        participanteSeleccionadoEmail = null;

        fraganciasProyecto = new();
        fraganciaSeleccionadaCodigo = null;

        try
        {
            var emailActual = UserSession.Email;
            if (string.IsNullOrWhiteSpace(emailActual))
            {
                mensajeError = "No se ha podido obtener el usuario actual. Vuelve a iniciar sesión.";
                return;
            }

            var creador = emailActual.Trim().ToLower();

            // 1) Fragancias asociadas al proyecto
            var rels = await EProyectoFragancia.ListarFraganciasPorProyectoAsync(p.Codigo);
            var todasFragancias = await EFragancia.ListarFraganciasPorCreadorAsync(creador);

            var codigosFragProyecto = rels.Select(r => r.FraganciaCodigo).ToHashSet();

            fraganciasProyecto = todasFragancias
                .Where(f => codigosFragProyecto.Contains(f.Codigo))
                .OrderBy(f => f.Nombre)
                .ToList();

            // 2) Si hay varias fragancias, selecciona una por defecto (IMPORTANTÍSIMO para no pasar NULL)
            if (fraganciasProyecto.Count > 1)
                fraganciaSeleccionadaCodigo = fraganciasProyecto[0].Codigo;

            // 3) Recarga disponibles con el filtro correcto
            await RecargarParticipantesDisponiblesAsync();

            empezarDialogVisible = true;
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando datos para empezar: " + ex.Message;
        }
    }

    private void CerrarDialogoEmpezar()
    {
        empezarDialogVisible = false;
        proyectoSeleccionado = null;

        participantesDisponibles = new();
        participanteSeleccionadoEmail = null;

        fraganciasProyecto = new();
        fraganciaSeleccionadaCodigo = null;

        dialogError = null;
        empezarBusy = false;
    }

    private void AbrirPopupNuevoParticipante()
    {
        dialogError = null;
        dialogoParticipanteVisible = true;
    }

    private void AbrirDialogoResultados(ProyectoModel p)
    {
        proyectoSeleccionado = p;
        resultadosDialogVisible = true;
    }

    private async Task RecargarParticipantesDisponiblesAsync()
    {
        if (proyectoSeleccionado == null) return;

        var creador = (UserSession.Email ?? "").Trim().ToLower();
        if (string.IsNullOrWhiteSpace(creador)) return;

        // Si hay varias fragancias => SIEMPRE filtrar por la seleccionada
        string? fragFiltro = null;

        if ((fraganciasProyecto?.Count ?? 0) > 1)
        {
            if (string.IsNullOrWhiteSpace(fraganciaSeleccionadaCodigo))
            {
                participantesDisponibles = new();
                return;
            }

            fragFiltro = fraganciaSeleccionadaCodigo.Trim();
        }
        else
        {
            // 0 o 1 fragancia => según tu regla, no filtrar por fragancia
            fragFiltro = null;
        }

        participantesDisponibles =
            await EParticipante.ListarParticipantesDisponiblesPorProyectoAsync(
                proyectoSeleccionado.Codigo,
                creador,
                fragFiltro
            );
    }

    private async Task OnFraganciaCambiada(object _)
    {
        participanteSeleccionadoEmail = null;
        await RecargarParticipantesDisponiblesAsync();
    }

    private async Task OnParticipanteCreado(string email)
    {
        try
        {
            // Autoseleccionar el recién creado
            var emailNorm = (email ?? "").Trim().ToLower();
            if (!string.IsNullOrWhiteSpace(emailNorm))
                participanteSeleccionadoEmail = emailNorm;

            await RecargarParticipantesDisponiblesAsync();

            mensajeOk = $"Participante \"{emailNorm}\" creado correctamente.";
        }
        catch (Exception ex)
        {
            dialogError = "Participante creado, pero no se pudo recargar la lista: " + ex.Message;
        }
    }

    private async Task ConfirmarEmpezarPrueba()
    {
        dialogError = null;

        if (proyectoSeleccionado == null)
        {
            dialogError = "No se ha podido obtener el proyecto.";
            return;
        }

        if (string.IsNullOrWhiteSpace(participanteSeleccionadoEmail))
        {
            dialogError = "Selecciona un participante.";
            return;
        }

        if ((fraganciasProyecto?.Count ?? 0) == 0)
        {
            dialogError = "Este proyecto no tiene fragancias asociadas.";
            return;
        }

        if (fraganciasProyecto.Count > 1 && string.IsNullOrWhiteSpace(fraganciaSeleccionadaCodigo))
        {
            dialogError = "Selecciona una fragancia.";
            return;
        }

        empezarBusy = true;

        try
        {
            var email = participanteSeleccionadoEmail.Trim().ToLower();

            // Si hay varias, usa la seleccionada; si hay 1, usa esa 
            var fraganciaCod = (fraganciasProyecto.Count > 1)
                ? fraganciaSeleccionadaCodigo!.Trim()
                : fraganciasProyecto[0].Codigo;

            // Crea la prueba 
            var pruebaCodigo = await EPrueba.CrearPruebaAsync(proyectoSeleccionado.Codigo, email, fraganciaCod);

            if (string.IsNullOrWhiteSpace(pruebaCodigo))
                throw new Exception("No se ha podido crear la prueba (código vacío).");

            await EPrueba.ActualizarFechaPruebaAsync(pruebaCodigo);

            var participanteEncoded = Uri.EscapeDataString(email);
            var pruebaEncoded = Uri.EscapeDataString(pruebaCodigo);
            var fraganciaEncoded = Uri.EscapeDataString(fraganciaCod);

            Nav.NavigateTo($"/prueba/{proyectoSeleccionado.Codigo}/{participanteEncoded}?pruebaCodigo={pruebaEncoded}&fraganciaCodigo={fraganciaEncoded}");
        }
        catch (PostgresException ex)
        {
            dialogError = ex.MessageText;
        }
        catch (Exception ex)
        {
            dialogError = "Error al empezar la prueba: " + ex.Message;
        }
        finally
        {
            empezarBusy = false;
            await RecargarParticipantesDisponiblesAsync();
        }
    }

    private async Task DescargarProyectos()
    {
        try
        {
            await ExportService.DescargarCsvAsync(proyectos, "Proyectos.csv");
        }
        catch (Exception ex)
        {
            mensajeError = "Error al descargar los proyectos: " + ex.Message;
        }
    }

    private async Task DescargarProyecto(ProyectoModel p)
    {
        await ExportService.DescargarCsvAsync(new[] { p }, $"ResumenProyecto_{p.Codigo}.csv");
    }
}
