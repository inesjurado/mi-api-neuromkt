@page "/estadisticas/{CodigoProyecto}"
@using NeuromktApi.Services
@inject IEResultado EResultado
@inject IEProyectoFragancia EProyectoFragancia
@inject NavigationManager Nav
@inject IJSRuntime JS

<RadzenCard Class="nf-page" Style="border:none; box-shadow:none;">
    <div class="nf-header">
        <RadzenCard Class="nf-title-card">
            <div class="nf-title-text">
                ESTADÍSTICAS – @CodigoProyecto
            </div>
        </RadzenCard>
    </div>

    <RadzenCard Class="nf-table-card" Style="margin-top:2rem;">

        <div style="
            display:grid;
            grid-template-columns:auto 1fr auto;
            gap:12px;
            align-items:center;
            margin-bottom:1rem;
        ">
            <div style="display:flex; align-items:center;">
                <RadzenButton Icon="arrow_back"
                            Text="Volver"
                            ButtonStyle="ButtonStyle.Light"
                            Click="@Volver" />
            </div>

            <div style="
                display:flex;
                flex-wrap:wrap;
                align-items:center;
                gap:12px;
                min-width:0;
            ">
                @if (_mostrarSelectorFragancia)
                {
                    <div style="display:flex; align-items:center; gap:8px; min-width:240px; flex:1 1 240px;">
                        <span style="font-weight:600; white-space:nowrap;">Fragancia:</span>
                        <RadzenDropDown TValue="string"
                                        Data="@_fraganciasDisponibles"
                                        TextProperty="Text"
                                        ValueProperty="Value"
                                        @bind-Value="_fraganciaCodigoSeleccionada"
                                        Style="width:100%;"
                                        Change="@OnFraganciaChanged" />
                    </div>
                }

                <div style="display:flex; align-items:center; gap:8px; min-width:220px; flex:1 1 220px;">
                    <span style="font-weight:600; white-space:nowrap;">Vista:</span>
                    <RadzenDropDown TValue="string"
                                    Data="@_modos"
                                    @bind-Value="_modoFiltro"
                                    Style="width:100%;"
                                    Change="@OnModoFiltroChanged" />
                </div>

                @if (_modoFiltro != "General")
                {
                    <div style="display:flex; align-items:center; gap:8px; min-width:240px; flex:1 1 240px;">
                        <span style="font-weight:600; white-space:nowrap;">
                            @(_modoFiltro == "Por género" ? "Género:" : "Edad:")
                        </span>

                        <RadzenDropDown TValue="string"
                                        Data="@_gruposDisponibles"
                                        @bind-Value="_grupoFiltroSeleccionado"
                                        Style="width:100%;"
                                        Change="@OnGrupoFiltroChanged"
                                        Placeholder="Selecciona..." />
                    </div>
                }
            </div>

            <div style="display:flex; justify-content:flex-end; align-items:center;">
                <RadzenButton Icon="picture_as_pdf"
                            Text="Descargar PDF"
                            ButtonStyle="ButtonStyle.Secondary"
                            Disabled="@cargando"
                            Click="@AbrirDialogoPdf"
                            Style="white-space:nowrap;" />
            </div>
        </div>
        <div style="display:none;"></div>


        @if (!string.IsNullOrEmpty(mensajeError))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Style="margin-top:1rem;">
                @mensajeError
            </RadzenAlert>
        }

        @if (cargando)
        {
            <div style="margin-top:1rem;">Cargando estadísticas...</div>
        }
        else
        {
            <h4 style="margin-top:1rem;">Colores</h4>

            @if (_modoFiltro != "General" && (_gruposDisponibles == null || _gruposDisponibles.Count == 0))
            {
                <div>No hay datos para esta vista.</div>
            }
            else if (statsColores.Count == 0)
            {
                <div>No hay datos de colores.</div>
            }
            else
            {
                <div style="display:flex; gap:2rem; align-items:flex-start; flex-wrap:wrap;">
                    <div style="width:420px; max-width:100%;">
                        <canvas id="pieColores" height="320"></canvas>
                    </div>

                    <!-- Leyenda personalizada (color real) -->
                    <div>
                        @if (_modoFiltro != "General" && !string.IsNullOrWhiteSpace(_grupoFiltroSeleccionado))
                        {
                            <div style="font-weight:700; margin-bottom:0.75rem;">
                                @(_modoFiltro == "Por género"
                                    ? $"Género: {_grupoFiltroSeleccionado}"
                                    : $"Edad: {_grupoFiltroSeleccionado}")
                            </div>
                        }

                        @foreach (var c in statsColores.OrderByDescending(x => x.Total))
                        {
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                                <div style="width:18px; height:18px; border-radius:4px; border:1px solid #ccc; background-color:@c.CssColor;"></div>
                                <div>@c.Valor</div>
                                <div style="opacity:.7;">(@c.Total)</div>
                            </div>
                        }
                    </div>
                </div>
            }

            <h4 style="margin-top:2rem;">Palabras</h4>

            @if (_modoFiltro != "General" && (_gruposDisponibles == null || _gruposDisponibles.Count == 0))
            {
                <div>No hay datos para esta vista.</div>
            }
            else if (statsPalabras.Count == 0)
            {
                <div>No hay datos de palabras.</div>
            }
            else
            {
                <div style="display:flex; gap:2rem; align-items:flex-start; flex-wrap:wrap;">
                    <div style="width:520px; max-width:100%;">
                        <canvas id="piePalabras" height="320"></canvas>
                    </div>

                    <!-- leyenda simple para palabras -->
                    <div>
                        @if (_modoFiltro != "General" && !string.IsNullOrWhiteSpace(_grupoFiltroSeleccionado))
                        {
                            <div style="font-weight:700; margin-bottom:0.75rem;">
                                @(_modoFiltro == "Por género"
                                    ? $"Género: {_grupoFiltroSeleccionado}"
                                    : $"Edad: {_grupoFiltroSeleccionado}")
                            </div>
                        }

                        @foreach (var p in statsPalabras.OrderByDescending(x => x.Total))
                        {
                            <div style="display:flex; gap:10px; margin-bottom:8px;">
                                <div>@p.Valor</div>
                                <div style="opacity:.7;">(@p.Total)</div>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </RadzenCard>
</RadzenCard>

@if (_pdfDialogVisible)
{
    <div class="nf-modal-backdrop">
        <RadzenCard Class="nf-modal-card">
            <div class="nf-modal-header">
                <span>Descargar PDF</span>
                <button type="button"
                        class="nf-modal-close"
                        @onclick="CerrarDialogoPdf">
                    ✕
                </button>
            </div>

            <div class="nf-dialog-form">

                @if (_mostrarSelectorFragancia)
                {
                    <div class="nf-form-field">
                        <label>Fragancia</label>
                        <RadzenDropDown TValue="string"
                                        Data="@_pdfFraganciasDisponibles"
                                        TextProperty="Text"
                                        ValueProperty="Value"
                                        @bind-Value="_pdfFraganciaCodigo"
                                        Style="width:100%;"
                                        Change="@OnPdfFraganciaChanged" />
                    </div>
                }

                <div class="nf-form-field">
                    <label>Modo</label>
                    <RadzenDropDown TValue="string"
                                    Data="@_pdfModos"
                                    @bind-Value="_pdfModo"
                                    Style="width:100%;"
                                    Change="@OnPdfModoChanged" />
                </div>

                @if (_pdfModo != "General")
                {
                    <div class="nf-form-field">
                        <label>@(_pdfModo == "Por género" ? "Género" : "Edad")</label>
                        <RadzenDropDown TValue="string"
                                        Data="@_pdfGruposDisponibles"
                                        @bind-Value="_pdfGrupoSeleccionado"
                                        Style="width:100%;"
                                        Placeholder="Selecciona..."
                                        Change="@((object _) => Task.CompletedTask)" />
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(_pdfError))
                {
                    <div class="nf-input-error">@_pdfError</div>
                }

                <div class="nf-form-actions">
                    <RadzenButton Text="Descargar"
                                  Icon="picture_as_pdf"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Disabled="@_pdfBusy"
                                  Click="@ConfirmarDescargarPdf" />

                    <RadzenButton Text="Cancelar"
                                  Icon="close"
                                  ButtonStyle="ButtonStyle.Light"
                                  Click="@CerrarDialogoPdf"
                                  Style="margin-left:0.5rem;" />
                </div>
            </div>
        </RadzenCard>
    </div>
}

@code {
    [Parameter] public string CodigoProyecto { get; set; } = string.Empty;

    [Parameter, SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    private bool cargando = true;
    private string? mensajeError;

    private bool _chartsRendered = false;

    private class StatRow
    {
        public string Valor { get; set; } = string.Empty;
        public int Total { get; set; }
        public string CssColor => (Valor ?? "").Trim().Replace(" ", "");
    }

    private class Opcion
    {
        public string Text { get; set; } = "";
        public string Value { get; set; } = "";
    }

    private List<StatRow> statsColores = new();
    private List<StatRow> statsPalabras = new();

    private string[] _labelsColores = Array.Empty<string>();
    private int[] _valuesColores = Array.Empty<int>();
    private string[] _colorsColores = Array.Empty<string>();

    private string[] _labelsPalabras = Array.Empty<string>();
    private int[] _valuesPalabras = Array.Empty<int>();
    private string[] _colorsPalabras = Array.Empty<string>();

    private readonly List<string> _modos = new() { "General", "Por género", "Por edad" };
    private string _modoFiltro = "General";

    private string? _grupoFiltroSeleccionado;
    private List<string> _gruposDisponibles = new();

    private bool _mostrarSelectorFragancia = false;
    private List<Opcion> _fraganciasDisponibles = new();
    private string _fraganciaCodigoSeleccionada = ""; 

    private string? FraganciaOrNull()
        => string.IsNullOrWhiteSpace(_fraganciaCodigoSeleccionada) ? null : _fraganciaCodigoSeleccionada;
    private bool _pdfDialogVisible = false;
    private bool _pdfBusy = false;
    private string? _pdfError;

    private readonly List<string> _pdfModos = new() { "General", "Por género", "Por edad" };
    private string _pdfModo = "General";
    private List<string> _pdfGruposDisponibles = new();
    private string? _pdfGrupoSeleccionado;

    private List<Opcion> _pdfFraganciasDisponibles = new();
    private string _pdfFraganciaCodigo = "";

    protected override async Task OnInitializedAsync()
    {
        await PrepararFraganciasAsync();
        await CargarTodoAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!cargando && !_chartsRendered)
        {
            _chartsRendered = true;

            if (_labelsColores.Length > 0)
            {
                await JS.InvokeVoidAsync("nfCharts.renderPie",
                    "pieColores",
                    _labelsColores,
                    _valuesColores,
                    _colorsColores,
                    _modoFiltro == "General"
                        ? "Colores"
                        : $"Colores ({_grupoFiltroSeleccionado})");
            }

            if (_labelsPalabras.Length > 0)
            {
                await JS.InvokeVoidAsync("nfCharts.renderBar",
                    "piePalabras",
                    _labelsPalabras,
                    _valuesPalabras,
                    _colorsPalabras,
                    _modoFiltro == "General"
                        ? "Palabras"
                        : $"Palabras ({_grupoFiltroSeleccionado})");
            }
        }
    }

    private async Task PrepararFraganciasAsync()
    {
        var filas = await EProyectoFragancia.ListarFraganciasPorProyectoAsync(CodigoProyecto);

        var opciones = filas
            .Where(x => !string.IsNullOrWhiteSpace(x.FraganciaCodigo))
            .Select(x => new Opcion
            {
                Value = x.FraganciaCodigo,
                Text  = string.IsNullOrWhiteSpace(x.FraganciaNombre) ? x.FraganciaCodigo : x.FraganciaNombre
            })
            .GroupBy(o => o.Value) 
            .Select(g => g.First())
            .OrderBy(o => o.Text)
            .ToList();

        _mostrarSelectorFragancia = opciones.Count >= 2;

        _fraganciasDisponibles = opciones;
        _fraganciaCodigoSeleccionada = _fraganciasDisponibles.FirstOrDefault()?.Value ?? "";
    }


    private async Task OnFraganciaChanged(object value)
    {
        _fraganciaCodigoSeleccionada = value?.ToString() ?? "";

        _grupoFiltroSeleccionado = null;
        _gruposDisponibles = new();

        await CargarTodoAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task CargarTodoAsync()
    {
        cargando = true;
        mensajeError = null;
        _chartsRendered = false;

        statsColores.Clear();
        statsPalabras.Clear();

        try
        {
            await PrepararGruposFiltroAsync();
            await CargarColoresAsync();
            await CargarPalabrasAsync();
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando estadísticas: " + ex.Message;
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task PrepararGruposFiltroAsync()
    {
        if (_modoFiltro == "General")
        {
            _gruposDisponibles = new();
            _grupoFiltroSeleccionado = null;
            return;
        }

        var frag = FraganciaOrNull();

        if (_modoFiltro == "Por género")
        {
            var filasC = await EResultado.EstadisticasColoresPorGeneroAsync(CodigoProyecto, frag);
            var filasP = await EResultado.EstadisticasPalabrasPorGeneroAsync(CodigoProyecto, frag);

            _gruposDisponibles = filasC.Select(x => x.UsuarioEmail)
                .Concat(filasP.Select(x => x.UsuarioEmail))
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .Distinct()
                .OrderBy(x => x)
                .ToList();

            _grupoFiltroSeleccionado ??= _gruposDisponibles.FirstOrDefault();
        }
        else // Por edad
        {
            var filasC = await EResultado.EstadisticasColoresPorEdadAsync(CodigoProyecto, frag);
            var filasP = await EResultado.EstadisticasPalabrasPorEdadAsync(CodigoProyecto, frag);

            _gruposDisponibles = filasC.Select(x => x.UsuarioEmail)
                .Concat(filasP.Select(x => x.UsuarioEmail))
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .Distinct()
                .OrderBy(x => x)
                .ToList();

            _grupoFiltroSeleccionado ??= _gruposDisponibles.FirstOrDefault();
        }
    }

    private async Task CargarColoresAsync()
    {
        var frag = FraganciaOrNull();

        if (_modoFiltro == "General")
        {
            var colores = await EResultado.EstadisticasColoresProyectoAsync(CodigoProyecto, frag);

            statsColores = colores
                .Select(x => new StatRow { Valor = x.Valor ?? "", Total = x.Total })
                .OrderByDescending(x => x.Total)
                .ToList();
        }
        else if (_modoFiltro == "Por género")
        {
            var filas = await EResultado.EstadisticasColoresPorGeneroAsync(CodigoProyecto, frag);

            statsColores = filas
                .Where(x => x.UsuarioEmail == _grupoFiltroSeleccionado)
                .Select(r => new StatRow { Valor = r.Valor ?? "", Total = r.Total })
                .OrderByDescending(r => r.Total)
                .ToList();
        }
        else // Por edad
        {
            var filas = await EResultado.EstadisticasColoresPorEdadAsync(CodigoProyecto, frag);

            statsColores = filas
                .Where(x => x.UsuarioEmail == _grupoFiltroSeleccionado)
                .Select(r => new StatRow { Valor = r.Valor ?? "", Total = r.Total })
                .OrderByDescending(r => r.Total)
                .ToList();
        }

        _labelsColores = statsColores.Select(x => x.Valor).ToArray();
        _valuesColores = statsColores.Select(x => x.Total).ToArray();
        _colorsColores = statsColores.Select(x => x.CssColor).ToArray();
    }

    private async Task CargarPalabrasAsync()
    {
        var frag = FraganciaOrNull();

        if (_modoFiltro == "General")
        {
            var palabras = await EResultado.EstadisticasPalabrasProyectoAsync(CodigoProyecto, frag);

            statsPalabras = palabras
                .Select(x => new StatRow { Valor = x.Valor ?? "", Total = x.Total })
                .OrderByDescending(x => x.Total)
                .ToList();
        }
        else if (_modoFiltro == "Por género")
        {
            var filas = await EResultado.EstadisticasPalabrasPorGeneroAsync(CodigoProyecto, frag);

            statsPalabras = filas
                .Where(x => x.UsuarioEmail == _grupoFiltroSeleccionado)
                .Select(r => new StatRow { Valor = r.Valor ?? "", Total = r.Total })
                .OrderByDescending(r => r.Total)
                .ToList();
        }
        else // Por edad
        {
            var filas = await EResultado.EstadisticasPalabrasPorEdadAsync(CodigoProyecto, frag);

            statsPalabras = filas
                .Where(x => x.UsuarioEmail == _grupoFiltroSeleccionado)
                .Select(r => new StatRow { Valor = r.Valor ?? "", Total = r.Total })
                .OrderByDescending(r => r.Total)
                .ToList();
        }

        _labelsPalabras = statsPalabras.Select(x => x.Valor).ToArray();
        _valuesPalabras = statsPalabras.Select(x => x.Total).ToArray();
        _colorsPalabras = GenerarColores(statsPalabras.Count);
    }

    private async Task OnModoFiltroChanged(object value)
    {
        _modoFiltro = value?.ToString() ?? "General";
        _grupoFiltroSeleccionado = null;
        _gruposDisponibles = new();

        await CargarTodoAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnGrupoFiltroChanged(object value)
    {
        _grupoFiltroSeleccionado = value?.ToString();

        await CargarColoresAsync();
        await CargarPalabrasAsync();

        _chartsRendered = false;
        await InvokeAsync(StateHasChanged);
    }

    private static string[] GenerarColores(int n)
    {
        if (n <= 0) return Array.Empty<string>();
        var res = new string[n];
        for (int i = 0; i < n; i++)
        {
            var hue = (int)(360.0 * i / n);
            res[i] = $"hsl({hue}, 70%, 55%)";
        }
        return res;
    }

    private string FraganciaNombreSeleccionada()
    {
        if (!_mostrarSelectorFragancia) return "";
        return _fraganciasDisponibles
            .FirstOrDefault(x => x.Value == _fraganciaCodigoSeleccionada)?.Text
            ?? _fraganciaCodigoSeleccionada;
    }

    private string PdfFraganciaNombreSeleccionada()
    {
        if (!_mostrarSelectorFragancia) return "";
        return _pdfFraganciasDisponibles
            .FirstOrDefault(x => x.Value == _pdfFraganciaCodigo)?.Text
            ?? _pdfFraganciaCodigo;
    }


    private async Task DescargarPdf()
    {
        try
        {
            var idColores = "pieColores";
            var idPalabras = "piePalabras";

            var fileName = $"estadisticas_{CodigoProyecto}.pdf";

            var nombreFrag = _mostrarSelectorFragancia ? FraganciaNombreSeleccionada() : "";
            var sufijoFrag = string.IsNullOrWhiteSpace(nombreFrag) ? "" : $" ({nombreFrag})";

            var sufijoModo = _modoFiltro == "General"
                ? " (General)"
                : $" ({_modoFiltro}: {_grupoFiltroSeleccionado})";

            var title = $"Estadísticas – {CodigoProyecto}{sufijoFrag}{sufijoModo}";

            await JS.InvokeVoidAsync("nfCharts.exportChartsPdf",
                fileName,
                title,
                idColores, "Colores",
                idPalabras, "Palabras"
            );
        }
        catch (Exception ex)
        {
            mensajeError = "Error al generar el PDF: " + ex.Message;
        }
    }

    private void Volver()
    {
        var destino = string.IsNullOrWhiteSpace(ReturnUrl) ? "/investProyecto" : ReturnUrl;

        if (!destino.StartsWith("/"))
            destino = "/" + destino;

        Nav.NavigateTo(destino);
    }

    private async Task AbrirDialogoPdf()
    {
        _pdfError = null;
        _pdfBusy = false;

        // sincroniza valores iniciales con la vista
        _pdfModo = _modoFiltro;
        if (!_pdfModos.Contains(_pdfModo))
            _pdfModo = "General";

        _pdfFraganciasDisponibles = _fraganciasDisponibles?.ToList() ?? new List<Opcion>();
        _pdfFraganciaCodigo = _fraganciaCodigoSeleccionada ?? "";

        await PrepararGruposPdfAsync();
        _pdfDialogVisible = true;
    }

    private void CerrarDialogoPdf()
    {
        _pdfDialogVisible = false;
        _pdfError = null;
        _pdfBusy = false;
    }

    private async Task OnPdfFraganciaChanged(object value)
    {
        _pdfFraganciaCodigo = value?.ToString() ?? "";
        _pdfGrupoSeleccionado = null;
        _pdfGruposDisponibles = new();

        await PrepararGruposPdfAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnPdfModoChanged(object value)
    {
        _pdfModo = value?.ToString() ?? "General";
        _pdfGrupoSeleccionado = null;
        _pdfGruposDisponibles = new();

        await PrepararGruposPdfAsync();
    }

    private async Task PrepararGruposPdfAsync()
    {
        if (_pdfModo == "General")
        {
            _pdfGruposDisponibles = new();
            _pdfGrupoSeleccionado = null;
            return;
        }

        string? frag = string.IsNullOrWhiteSpace(_pdfFraganciaCodigo) ? null : _pdfFraganciaCodigo;

        if (_pdfModo == "Por género")
        {
            var filasC = await EResultado.EstadisticasColoresPorGeneroAsync(CodigoProyecto, frag);
            var filasP = await EResultado.EstadisticasPalabrasPorGeneroAsync(CodigoProyecto, frag);

            var grupos = filasC.Select(x => x.UsuarioEmail)
                .Concat(filasP.Select(x => x.UsuarioEmail))
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .Distinct()
                .OrderBy(x => x)
                .ToList();

            _pdfGruposDisponibles = grupos;
            _pdfGrupoSeleccionado ??= grupos.FirstOrDefault();
        }
        else // Por edad
        {
            var filasC = await EResultado.EstadisticasColoresPorEdadAsync(CodigoProyecto, frag);
            var filasP = await EResultado.EstadisticasPalabrasPorEdadAsync(CodigoProyecto, frag);

            var grupos = filasC.Select(x => x.UsuarioEmail)
                .Concat(filasP.Select(x => x.UsuarioEmail))
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .Distinct()
                .OrderBy(x => x)
                .ToList();

            _pdfGruposDisponibles = grupos;
            _pdfGrupoSeleccionado ??= grupos.FirstOrDefault();
        }
    }

    private async Task ConfirmarDescargarPdf()
    {
        _pdfError = null;
        if (_pdfBusy) return;

        if (_pdfModo != "General" && string.IsNullOrWhiteSpace(_pdfGrupoSeleccionado))
        {
            _pdfError = "Selecciona un grupo.";
            return;
        }

        _pdfBusy = true;

        try
        {
            // sincroniza el filtro de la vista con el diálogo PDF
            _fraganciaCodigoSeleccionada = _mostrarSelectorFragancia ? (_pdfFraganciaCodigo ?? "") : "";
            _modoFiltro = _pdfModo;
            _grupoFiltroSeleccionado = _pdfModo == "General" ? null : _pdfGrupoSeleccionado;

            await CargarTodoAsync();
            await InvokeAsync(StateHasChanged);

            await JS.InvokeVoidAsync("nfCharts.waitTwoFrames");
            await DescargarPdf();

            CerrarDialogoPdf();
        }
        catch (Exception ex)
        {
            _pdfError = "Error preparando el PDF: " + ex.Message;
        }
        finally
        {
            _pdfBusy = false;
        }
    }
}
