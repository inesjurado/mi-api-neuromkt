@page "/usuario-test"
@using NeuromktApi.Models
@using NeuromktApi.Services
@using Npgsql
@inject IJSRuntime JS
@inject IEUsuario EUsuario
@inject IExportService ExportService

<RadzenCard Class="nf-page" Style="border:none; box-shadow:none;">

    <div class="nf-header">
        <RadzenCard Class="nf-title-card">
            <div class="nf-title-text">PERFILES</div>
        </RadzenCard>
    </div>

    <!-- Toolbar -->
    <div class="nf-toolbar">
        <RadzenButton Icon="person_add"
                      Text="Nuevo Perfil"
                      ButtonStyle="ButtonStyle.Primary"
                      Disabled="@busy"
                      Click="@NuevoUsuario" />

        <RadzenButton Icon="file_download"
              Text="Descargar Usuarios"
              ButtonStyle="ButtonStyle.Secondary"
              Disabled="@(!usuarios.Any())"
              Click="@DescargarUsuarios" />
    </div>

    <!-- Mensajes -->
    @if (!string.IsNullOrEmpty(mensajeOk))
    {
        <RadzenAlert Severity="AlertSeverity.Success" Style="margin-bottom:1rem;">
            @mensajeOk
        </RadzenAlert>
    }

    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <RadzenAlert Severity="AlertSeverity.Error" Style="margin-bottom:1rem;">
            @mensajeError
        </RadzenAlert>
    }

    <!-- Tabla -->
    <RadzenCard Class="nf-table-card">
        <RadzenDataGrid TItem="UsuarioModel"
                        Data="@usuarios"
                        AllowFiltering="true"
                        FilterMode="FilterMode.Advanced"
                        AllowSorting="true" 
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        AllowPaging="false"
                        RowHover="true"
                        Style="width:100%;">

            <Columns>

                <RadzenDataGridColumn TItem="UsuarioModel"
                                      Property="Nombre"
                                      Title="Perfil"
                                      Filterable="true" />

                <RadzenDataGridColumn TItem="UsuarioModel"
                                      Property="Email"
                                      Title="Email" />

                <RadzenDataGridColumn TItem="UsuarioModel"
                                      Property="Rol"
                                      Title="Rol" />

                <RadzenDataGridColumn TItem="UsuarioModel"
                                      Title="Acciones"
                                      Width="120px"
                                      Filterable="false">
                    <Template Context="item">

                        <RadzenButton Icon="edit"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@(() => EditarUsuario(item))"
                                      Style="margin-right:0.5rem;" />
                        
                        <RadzenButton Icon="file_download"
                                        Size="ButtonSize.Small"
                                        ButtonStyle="ButtonStyle.Light"
                                        Style="margin-right:0.5rem;"
                                        Click="@(() => DescargarPerfil(item))" />


                        <RadzenButton Icon="delete"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@(() => BorrarUsuario(item))" />

                    </Template>
                </RadzenDataGridColumn>

            </Columns>

        </RadzenDataGrid>
    </RadzenCard>
</RadzenCard>


<!-- ==== Component popup ==== -->
<UsuarioForm Visible="@popupVisible"
             VisibleChanged="@(v => popupVisible = v)"
             EsEdicion="@popupEsEdicion"
             Usuario="@usuarioSeleccionado"
             OnGuardado="@OnGuardadoUsuario" />

@code {

    private List<UsuarioModel> usuarios = new();
    private bool busy = false;

    private string? mensajeOk;
    private string? mensajeError;

    // Estado del popup
    private bool popupVisible = false;
    private bool popupEsEdicion = false;
    private UsuarioModel? usuarioSeleccionado;


    protected override async Task OnInitializedAsync()
    {
        await CargarUsuariosAsync();
    }

    private async Task CargarUsuariosAsync()
    {
        try
        {
            usuarios = await EUsuario.ListarUsuariosAsync();
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando usuarios: " + ex.Message;
        }
    }

    // ======== NUEVO =========
    private void NuevoUsuario()
    {
        popupEsEdicion = false;
        usuarioSeleccionado = null;
        popupVisible = true;
        mensajeOk = null;
        mensajeError = null;
    }

    // ======== EDITAR =========
    private void EditarUsuario(UsuarioModel u)
    {
        popupEsEdicion = true;
        usuarioSeleccionado = u;
        popupVisible = true;
        mensajeOk = null;
        mensajeError = null;
    }

    private async Task OnGuardadoUsuario(string email)
    {
        await CargarUsuariosAsync();
        mensajeOk = popupEsEdicion
            ? $"Usuario {email} actualizado correctamente."
            : $"Usuario {email} creado correctamente.";
    }

    // ======== BORRAR =========
    private async Task BorrarUsuario(UsuarioModel usuario)
    {
        if (busy) return;

        var confirmar = await JS.InvokeAsync<bool>(
            "confirm",
            $"Â¿Seguro que quieres eliminar al usuario {usuario.Email}?");

        if (!confirmar)
            return;

        busy = true;
        mensajeOk = null;
        mensajeError = null;

        try
        {
            await EUsuario.EliminarUsuarioAsync(usuario.Email);
            await CargarUsuariosAsync();
            mensajeOk = $"Usuario {usuario.Email} eliminado correctamente.";
        }
        catch (PostgresException ex)
        {
            mensajeError = ex.MessageText;
        }
        catch (Exception ex)
        {
            mensajeError = "Error inesperado: " + ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    private async Task DescargarUsuarios()
    {
        try
        {
            await ExportService.DescargarCsvAsync(usuarios, "usuarios.csv");
        }
        catch (Exception ex)
        {
            mensajeError = "Error al descargar los usuarios: " + ex.Message;
        }
    }

    private async Task DescargarPerfil(UsuarioModel perfil)
    {
        await ExportService.DescargarCsvAsync(new[] { perfil }, $"Perfil_{perfil.Nombre}.csv");
    }

}
