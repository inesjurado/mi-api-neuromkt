@page "/"
@page "/login"
@layout BlankLayout
@using NeuromktApi.Services
@inject NavigationManager NavigationManager
@inject UserSession UserSession
@inject IEUsuario EUsuario

<div class="login-page">
    <div class="login-logo-upv">
        <img src="images/upv.png"
            alt="UPV"
            class="login-logo-img" />
    </div>

    <div class="login-logo-macom">
        <img src="images/MACOM.png"
            alt="MACOM"
            class="login-logo-img" />
    </div>
    <RadzenCard Class="login-card">
        <div class="login-header">
            <h1>NEUROFRAGANCIAS</h1>
            <p>Plataforma de neuromarketing</p>
        </div>

        <div class="login-form">
            <RadzenTextBox @bind-Value="Email"
                           Placeholder="Email"
                           Style="width:100%; margin-bottom: 1rem;" />

            <div class="password-wrapper">
                <RadzenTextBox @bind-Value="Password"
                            Placeholder="Contraseña"
                            Name="Password"
                            Style="width:100%; padding-right:3rem;"
                            type="@(_mostrarPassword ? "text" : "password")" />

                <button type="button"
                        class="password-toggle-pill"
                        @onclick="TogglePassword"
                        aria-label="Mostrar u ocultar contraseña">
                    @if (_mostrarPassword)
                    {
                        <!-- OJO TACHADO -->
                        <svg viewBox="0 0 24 24" class="eye-icon">
                            <path d="M3 12c2.5-4 5.5-6 9-6 1.2 0 2.3.2 3.3.6" />
                            <path d="M21 12c-2.5 4-5.5 6-9 6-1.3 0-2.5-.3-3.6-.7" />
                            <circle cx="12" cy="12" r="2.5" />
                            <line x1="4" y1="4" x2="20" y2="20" />
                        </svg>
                    }
                    else
                    {
                        <!-- OJO NORMAL -->
                        <svg viewBox="0 0 24 24" class="eye-icon">
                            <path d="M3 12c2.5-4 5.5-6 9-6s6.5 2 9 6c-2.5 4-5.5 6-9 6s-6.5-2-9-6z" />
                            <circle cx="12" cy="12" r="2.5" />
                        </svg>
                    }
                </button>
            </div>



            <RadzenButton Text="Iniciar sesión"
                          ButtonStyle="ButtonStyle.Primary"
                          Style="width:100%;"
                          Click="@OnLogin" />

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div style="margin-top:0.75rem; color:#c62828; font-size:0.9rem;">
                    @ErrorMessage
                </div>
            }
        </div>
    </RadzenCard>
</div>

@code {
    string? Email;
    string? Password;
    string? ErrorMessage;

    async Task OnLogin()
    {
        ErrorMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Password))
        {
            ErrorMessage = "Introduce el email y la contraseña.";
            return;
        }

        var (ok, rol) = await EUsuario.LoginAsync(Email!, Password!);

        if (!ok || string.IsNullOrEmpty(rol))
        {
            ErrorMessage = "Usuario o contraseña incorrectos, o usuario inactivo.";
            return;
        }

        // Guardamos en la sesión
        UserSession.Role = rol;
        UserSession.Email = Email; 

        if (rol == "Administrador")
        {
            NavigationManager.NavigateTo("/proyectos");
        }
        else if (rol == "Investigador")
        {
            NavigationManager.NavigateTo("/investProyecto");
        }
    }

    bool _mostrarPassword = false;

    void TogglePassword()
    {
        _mostrarPassword = !_mostrarPassword;
    }

}
