@page "/configuracion"
@using NeuromktApi.Models
@using NeuromktApi.Services
@using Npgsql

@inject IJSRuntime JS
@inject IEColor EColor
@inject IEPalabra EPalabra
@inject IExportService ExportService

<RadzenCard Class="nf-page" Style="border:none; box-shadow:none;">

    <!-- Cabecera -->
    <div class="nf-header">
        <RadzenCard Class="nf-title-card">
            <div class="nf-title-text">
                CONFIGURACION
            </div>
        </RadzenCard>
    </div>

    <div class="config-columns">

        @* ========= COLORES ========= *@
        <RadzenCard Class="nf-table-card">
            <div class="nf-toolbar">
                <RadzenButton Icon="add_circle"
                              Text="Nuevo Color"
                              ButtonStyle="ButtonStyle.Primary"
                              Disabled="@busyColor"
                              Click="@AbrirNuevoColor" />

                <RadzenButton Icon="file_download"
                        Text="Descargar Colores"
                        ButtonStyle="ButtonStyle.Secondary"
                        Disabled="@(!colores.Any())"
                        Click="@DescargarColores" />
            </div>

            @if (!string.IsNullOrEmpty(mensajeColorOk))
            {
                <RadzenAlert Severity="AlertSeverity.Success"
                             Style="margin-bottom:0.75rem;">
                    @mensajeColorOk
                </RadzenAlert>
            }

            @if (!string.IsNullOrEmpty(mensajeColorError))
            {
                <RadzenAlert Severity="AlertSeverity.Error"
                             Style="margin-bottom:0.75rem;">
                    @mensajeColorError
                </RadzenAlert>
            }

            <RadzenDataGrid TItem="ColorModel"
                            Data="@colores"
                            RowHover="true"
                            AllowPaging="false"
                            ShowPagingSummary="false"
                            Style="width:100%;">
                <Columns>
                    <RadzenDataGridColumn TItem="ColorModel"
                                          Title="Color">
                        <Template Context="c">
                            <div class="nf-color-main">
                                <span class="nf-color-swatch" style="background-color:@c.Hex"></span>
                                <div class="nf-color-text">
                                    <div class="nf-color-hex">@c.Hex</div>
                                </div>
                            </div>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="ColorModel"
                                          Title="Acciones"
                                          Width="150px">
                        <Template Context="c">
                            <RadzenButton Icon="edit"
                                          Size="ButtonSize.Small"
                                          ButtonStyle="ButtonStyle.Light"
                                          Style="margin-right:0.5rem;"
                                          Click="@(() => AbrirEditarColor(c))" />
                            <RadzenButton Icon="delete"
                                          Size="ButtonSize.Small"
                                          ButtonStyle="ButtonStyle.Light"
                                          Click="@(() => BorrarColor(c))" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>

        @* ========= PALABRAS ========= *@
        <RadzenCard Class="nf-table-card" Style="margin-top:2rem;">

            <div class="nf-toolbar">
                <RadzenButton Icon="add_circle"
                              Text="Nueva Palabra"
                              ButtonStyle="ButtonStyle.Primary"
                              Disabled="@busyPalabra"
                              Click="@AbrirNuevaPalabra" />

                <RadzenButton Icon="file_download"
                        Text="Descargar Palabras"
                        ButtonStyle="ButtonStyle.Secondary"
                        Disabled="@(!palabras.Any())"
                        Click="@DescargarPalabras" />
            </div>

            @if (!string.IsNullOrEmpty(mensajePalabraOk))
            {
                <RadzenAlert Severity="AlertSeverity.Success"
                             Style="margin-bottom:0.75rem;">
                    @mensajePalabraOk
                </RadzenAlert>
            }

            @if (!string.IsNullOrEmpty(mensajePalabraError))
            {
                <RadzenAlert Severity="AlertSeverity.Error"
                             Style="margin-bottom:0.75rem;">
                    @mensajePalabraError
                </RadzenAlert>
            }

            <RadzenDataGrid TItem="PalabraModel"
                            Data="@palabras"
                            RowHover="true"
                            AllowPaging="false"
                            ShowPagingSummary="false"
                            AllowFiltering="true"
                            FilterMode="FilterMode.Advanced"
                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                            Style="width:100%;">
                <Columns>
                    <RadzenDataGridColumn TItem="PalabraModel"
                                          Property="Palabra"
                                          Title="Palabra"
                                          Filterable="true"
                                          FilterOperator="FilterOperator.Contains" />

                    <RadzenDataGridColumn TItem="PalabraModel"
                                          Title="Acciones"
                                          Width="150px"
                                          Filterable="false">
                        <Template Context="p">
                            <RadzenButton Icon="edit"
                                          Size="ButtonSize.Small"
                                          ButtonStyle="ButtonStyle.Light"
                                          Style="margin-right:0.5rem;"
                                          Click="@(() => AbrirEditarPalabra(p))" />
                            <RadzenButton Icon="delete"
                                          Size="ButtonSize.Small"
                                          ButtonStyle="ButtonStyle.Light"
                                          Click="@(() => BorrarPalabra(p))" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

        </RadzenCard>

    </div>
</RadzenCard>

@* ==== POPUPS REUTILIZABLES ==== *@
<ColorForm Visible="@dialogColorVisible"
           VisibleChanged="@(v => dialogColorVisible = v)"
           EsEdicion="@dialogColorEsEdicion"
           ColorActual="@colorSeleccionado"
           OnGuardado="@OnColorGuardado" />

<PalabraForm Visible="@dialogPalabraVisible"
             VisibleChanged="@(v => dialogPalabraVisible = v)"
             EsEdicion="@dialogPalabraEsEdicion"
             PalabraOriginal="@palabraSeleccionada"
             OnGuardado="@OnPalabraGuardada" />

@code {
    // === MODELOS EN MEMORIA ===
    private List<ColorModel> colores = new();
    private List<PalabraModel> palabras = new();

    // ----- Colores -----
    private bool busyColor = false;
    private string? mensajeColorOk;
    private string? mensajeColorError;

    // estado del diálogo de color
    private bool dialogColorVisible = false;
    private bool dialogColorEsEdicion = false;
    private ColorModel? colorSeleccionado;

    // ----- Palabras -----
    private bool busyPalabra = false;
    private string? mensajePalabraOk;
    private string? mensajePalabraError;

    // estado del diálogo de palabra
    private bool dialogPalabraVisible = false;
    private bool dialogPalabraEsEdicion = false;
    private string? palabraSeleccionada;

    // ===== CARGA INICIAL =====
    protected override async Task OnInitializedAsync()
    {
        await CargarColoresAsync();
        await CargarPalabrasAsync();
    }

    // ===== COLORES =====
    private async Task CargarColoresAsync()
    {
        try
        {
            colores = await EColor.ListarColoresAsync();
        }
        catch (Exception ex)
        {
            mensajeColorError = "Error cargando colores: " + ex.Message;
        }
    }

    private void AbrirNuevoColor()
    {
        dialogColorEsEdicion = false;
        colorSeleccionado = null;
        dialogColorVisible = true;
        mensajeColorOk = null;
        mensajeColorError = null;
    }

    private void AbrirEditarColor(ColorModel c)
    {
        dialogColorEsEdicion = true;
        colorSeleccionado = c;
        dialogColorVisible = true;
        mensajeColorOk = null;
        mensajeColorError = null;
    }

    private async Task OnColorGuardado(string hex)
    {
        await CargarColoresAsync();
        mensajeColorOk = dialogColorEsEdicion
            ? "Color actualizado correctamente."
            : $"Color {hex} añadido correctamente.";
        mensajeColorError = null;
    }

    private async Task BorrarColor(ColorModel color)
    {
        if (busyColor) return;

        var confirmar = await JS.InvokeAsync<bool>(
            "confirm", $"¿Seguro que quieres eliminar el color {color.Hex}?");

        if (!confirmar) return;

        mensajeColorOk = null;
        mensajeColorError = null;
        busyColor = true;

        try
        {
            await EColor.EliminarColorAsync(color.Hex);
            mensajeColorOk = "Color eliminado correctamente.";
            await CargarColoresAsync();
        }
        catch (PostgresException ex)
        {
            mensajeColorError = ex.MessageText;
        }
        catch (Exception ex)
        {
            mensajeColorError = "Error inesperado: " + ex.Message;
        }
        finally
        {
            busyColor = false;
        }
    }

    private async Task DescargarColores()
    {
        try
        {
            await ExportService.DescargarCsvAsync(colores, "colores.csv");
        }
        catch (Exception ex)
        {
            mensajeColorError = "Error al descargar los colores: " + ex.Message;
        }
    }

    // ===== PALABRAS =====
    private async Task CargarPalabrasAsync()
    {
        try
        {
            palabras = await EPalabra.ListarPalabrasAsync();
        }
        catch (Exception ex)
        {
            mensajePalabraError = "Error cargando palabras: " + ex.Message;
        }
    }

    private void AbrirNuevaPalabra()
    {
        dialogPalabraEsEdicion = false;
        palabraSeleccionada = null;
        dialogPalabraVisible = true;
        mensajePalabraOk = null;
        mensajePalabraError = null;
    }

    private void AbrirEditarPalabra(PalabraModel p)
    {
        dialogPalabraEsEdicion = true;
        palabraSeleccionada = p.Palabra;
        dialogPalabraVisible = true;
        mensajePalabraOk = null;
        mensajePalabraError = null;
    }

    private async Task OnPalabraGuardada(string palabra)
    {
        await CargarPalabrasAsync();
        mensajePalabraOk = dialogPalabraEsEdicion
            ? "Palabra actualizada correctamente."
            : $"Palabra '{palabra}' añadida correctamente.";
        mensajePalabraError = null;
    }

    private async Task BorrarPalabra(PalabraModel palabra)
    {
        if (busyPalabra) return;

        var confirmar = await JS.InvokeAsync<bool>(
            "confirm", $"¿Seguro que quieres eliminar la palabra '{palabra.Palabra}'?");

        if (!confirmar) return;

        mensajePalabraOk = null;
        mensajePalabraError = null;
        busyPalabra = true;

        try
        {
            await EPalabra.EliminarPalabraAsync(palabra.Palabra);
            mensajePalabraOk = $"Palabra '{palabra.Palabra}' eliminada correctamente.";
            await CargarPalabrasAsync();
        }
        catch (PostgresException ex)
        {
            mensajePalabraError = ex.MessageText;
        }
        catch (Exception ex)
        {
            mensajePalabraError = "Error inesperado: " + ex.Message;
        }
        finally
        {
            busyPalabra = false;
        }
    }

    private async Task DescargarPalabras()
    {
        try
        {
            await ExportService.DescargarCsvAsync(palabras, "palabras.csv");
        }
        catch (Exception ex)
        {
            mensajePalabraError = "Error al descargar las palabras: " + ex.Message;
        }
    }
}
