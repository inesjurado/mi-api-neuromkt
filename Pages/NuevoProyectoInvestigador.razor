@page "/nuevoProyecto"
@page "/nuevoProyecto/{CodigoProyecto}"

@using NeuromktApi.Models
@using NeuromktApi.Services
@using Npgsql
@using System.Linq
@using Microsoft.AspNetCore.Components

@inject UserSession UserSession
@inject IEProyectoFragancia EProyectoFragancia
@inject IEPrueba EPrueba
@inject IEProyecto EProyecto
@inject IEColor EColor
@inject IEPalabra EPalabra
@inject IEFragancia EFragancia
@inject IEParticipante EParticipante
@inject IEProyectoPalabra ProyectoPalabraService
@inject IEProyectoColor ProyectoColorService
@inject IEResultado EResultado
@inject IJSRuntime JS
@inject NavigationManager Nav

<RadzenCard Class="nf-page" Style="border:none; box-shadow:none;">

    <div class="nf-header">
        <RadzenCard Class="nf-title-card">
            <div class="nf-title-text">
                @(EsEdicion ? "EDITAR PROYECTO" : "NUEVO PROYECTO")
            </div>
        </RadzenCard>
    </div>

    <RadzenCard Class="nf-table-card" Style="margin-top:2rem; max-width:900px; margin-left:auto; margin-right:auto;">

        @if (!string.IsNullOrEmpty(mensajeOk))
        {
            <RadzenAlert Severity="AlertSeverity.Success" Style="margin-bottom:0.75rem;">
                @mensajeOk
            </RadzenAlert>
        }

        @if (!string.IsNullOrEmpty(mensajeError))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Style="margin-bottom:0.75rem;">
                @mensajeError
            </RadzenAlert>
        }

        <div class="nf-form-vertical">

            <div class="nf-form-field">
                <label class="nf-label">Nombre del proyecto:</label>
                <RadzenTextBox @bind-Value="proyecto.Nombre" Style="width:100%;" />
                @if (!string.IsNullOrEmpty(errorNombre))
                {
                    <div class="nf-input-error">@errorNombre</div>
                }
            </div>

            <div class="nf-form-field">
                <label class="nf-label">Fabricante / marca:</label>
                <RadzenTextBox @bind-Value="proyecto.Proveedor" Style="width:100%;" />
                @if (!string.IsNullOrEmpty(errorProveedor))
                {
                    <div class="nf-input-error">@errorProveedor</div>
                }
            </div>

            <div class="nf-form-field">
                <label class="nf-label">Descripción breve:</label>
                <RadzenTextArea @bind-Value="proyecto.Descripcion" Rows="3" Style="width:100%;" />
            </div>

            <hr />

            <div class="nf-form-field">
                <label class="nf-label">Palabras:</label>
                <div style="display:flex; align-items:center; gap:0.75rem;">
                    <RadzenDropDown Data="@palabras"
                                    TextProperty="Palabra"
                                    ValueProperty="Palabra"
                                    @bind-Value="seleccionPalabras"
                                    Multiple="true"
                                    Style="flex:1;"
                                    Placeholder="Selecciona las palabras a usar" />

                    <RadzenButton Icon="add_circle"
                                  Text="Añadir"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Click="@AbrirNuevaPalabraDesdeProyecto" />
                </div>
                @if (!string.IsNullOrEmpty(errorPalabras))
                {
                    <div class="nf-input-error">@errorPalabras</div>
                }
            </div>

            <div class="nf-form-field">
                <label class="nf-label">Colores:</label>
                <div style="display:flex; align-items:center; gap:0.75rem;">
                    <RadzenDropDown Data="@colores"
                                    @bind-Value="seleccionColores"
                                    Multiple="true"
                                    Style="flex:1;"
                                    Placeholder="Selecciona los colores a usar"
                                    TextProperty="Hex"
                                    ValueProperty="Hex">
                        <Template Context="c">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div style="width:18px; height:18px; border-radius:4px; background-color:@c.Hex;"></div>
                                @c.Hex
                            </div>
                        </Template>
                    </RadzenDropDown>

                    <RadzenButton Icon="add_circle"
                                  Text="Añadir"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Click="@AbrirNuevoColorDesdeProyecto" />
                </div>
                @if (!string.IsNullOrEmpty(errorColores))
                {
                    <div class="nf-input-error">@errorColores</div>
                }
            </div>

            <div class="nf-form-field">
                <label class="nf-label">Fragancia(s):</label>
                <div style="display:flex; align-items:center; gap:0.75rem;">
                    <RadzenDropDown Data="@fragancias"
                                    TextProperty="Nombre"
                                    ValueProperty="Codigo"
                                    @bind-Value="seleccionFragancias"
                                    Multiple="true"
                                    Style="flex:1;"
                                    Placeholder="Selecciona las fragancias del proyecto" />

                    <RadzenButton Icon="add_circle"
                                  Text="Añadir"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Click="@AbrirNuevaFraganciaDesdeProyecto" />
                </div>
                @if (!string.IsNullOrEmpty(errorFragancias))
                {
                    <div class="nf-input-error">@errorFragancias</div>
                }
            </div>

            <hr />

            <div class="nf-form-field">
                <label class="nf-label">Participantes:</label>
                <div style="display:flex; align-items:center; gap:0.75rem;">

                    <RadzenButton Icon="add_circle"
                                  Text="Crear Participante"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Click="@AbrirNuevoParticipanteDesdeProyecto" />
                </div>
            </div>

            <div class="nf-form-actions" style="margin-top:1.5rem; display:flex; flex-wrap:wrap; gap:0.75rem;">
                <RadzenButton Text="Guardar"
                              Icon="save"
                              ButtonStyle="ButtonStyle.Secondary"
                              Disabled="@busy"
                              Click="@(() => GuardarProyecto(false))" />

                <RadzenButton Text="Cancelar"
                              ButtonStyle="ButtonStyle.Light"
                              Click="@Cancelar" />
            </div>

        </div>

    </RadzenCard>

</RadzenCard>

<NuevaFragancia Visible="@dialogoFraganciaVisible"
                VisibleChanged="@(v => dialogoFraganciaVisible = v)"
                EsEdicion="false"
                OnGuardado="@OnFraganciaCreada" />

<NuevoParticipante Visible="@dialogoParticipanteVisible"
                   VisibleChanged="@(v => dialogoParticipanteVisible = v)"
                   EsEdicion="false"
                   OnGuardado="@OnParticipanteCreado" />

<ColorForm Visible="@dialogColorVisible"
           VisibleChanged="@(v => dialogColorVisible = v)"
           EsEdicion="false"
           ColorActual="null"
           OnGuardado="@OnColorCreado" />

<PalabraForm Visible="@dialogPalabraVisible"
             VisibleChanged="@(v => dialogPalabraVisible = v)"
             EsEdicion="false"
             PalabraOriginal="null"
             OnGuardado="@OnPalabraCreada" />

@code {
    private ProyectoModel proyecto = new ProyectoModel();

    [Parameter] public string? CodigoProyecto { get; set; }
    private bool EsEdicion => !string.IsNullOrWhiteSpace(CodigoProyecto);

    private List<PalabraModel> palabras = new();
    private List<ColorModel> colores = new();
    private List<FraganciaModel> fragancias = new();
    private List<ParticipanteModel> participantes = new(); 

    private IList<string> seleccionPalabras = new List<string>();
    private IList<string> seleccionColores = new List<string>();
    private IList<string> seleccionFragancias = new List<string>();

    private int? numParticipantesProyecto = 0;

    private bool busy = false;
    private string? mensajeOk;
    private string? mensajeError;

    private bool dialogoFraganciaVisible = false;
    private bool dialogoParticipanteVisible = false;

    private bool dialogColorVisible = false;
    private bool dialogPalabraVisible = false;

    private string? errorNombre;
    private string? errorProveedor;
    private string? errorDescripcion;
    private string? errorPalabras;
    private string? errorColores;
    private string? errorFragancias;

    protected override async Task OnInitializedAsync()
    {
        await CargarCombosAsync();

        if (EsEdicion)
        {
            await CargarProyectoExistenteAsync();
        }
        else
        {
            numParticipantesProyecto = 0;
        }
    }

    private async Task CargarProyectoExistenteAsync()
    {
        try
        {
            proyecto = await EProyecto.ObtenerProyectoAsync(CodigoProyecto!);

            var palabrasProyecto = await ProyectoPalabraService.ListarPalabrasPorProyectoAsync(CodigoProyecto!);
            seleccionPalabras = palabrasProyecto.Select(p => p.Palabra).ToList();

            var coloresProyecto = await ProyectoColorService.ListarColoresPorProyectoAsync(CodigoProyecto!);
            seleccionColores = coloresProyecto.Select(c => c.ColorHex).ToList();

            var fraganciasProyecto = await EProyectoFragancia.ListarFraganciasPorProyectoAsync(CodigoProyecto!);
            seleccionFragancias = fraganciasProyecto.Select(f => f.FraganciaCodigo).ToList();

            var pruebasProyecto = await EPrueba.ListarPruebasPorProyectoAsync(CodigoProyecto!);
            numParticipantesProyecto = pruebasProyecto?.Count ?? 0;
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando el proyecto: " + ex.Message;
        }
    }

    private async Task CargarCombosAsync()
    {
        try
        {
            var emailActual = UserSession.Email;
            palabras = await EPalabra.ListarPalabrasAsync();
            colores = await EColor.ListarColoresAsync();
            fragancias = await EFragancia.ListarFraganciasPorCreadorAsync(emailActual);

            participantes = await EParticipante.ListarParticipantesPorCreadorAsync(UserSession.Email!);
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando datos del formulario: " + ex.Message;
        }
    }

    private void AbrirNuevaFraganciaDesdeProyecto() => dialogoFraganciaVisible = true;
    private void AbrirNuevoParticipanteDesdeProyecto() => dialogoParticipanteVisible = true;
    private void AbrirNuevoColorDesdeProyecto() => dialogColorVisible = true;
    private void AbrirNuevaPalabraDesdeProyecto() => dialogPalabraVisible = true;

    private async Task OnFraganciaCreada(string codigo)
    {
        await CargarCombosAsync();

        var nueva = fragancias.FirstOrDefault(f => f.Codigo == codigo);
        if (nueva != null && !seleccionFragancias.Contains(codigo))
            seleccionFragancias.Add(codigo);

        mensajeOk = $"Fragancia \"{nueva?.Nombre ?? codigo}\" creada correctamente.";
    }

    private async Task OnParticipanteCreado(string email)
    {
        await CargarCombosAsync();

        email = (email ?? "").Trim().ToLower();
        if (!string.IsNullOrWhiteSpace(email))
            mensajeOk = $"Participante \"{email}\" creado correctamente.";
        else
            mensajeOk = "Participante creado correctamente.";
    }

    private async Task OnColorCreado(string hex)
    {
        await CargarCombosAsync();

        if (!seleccionColores.Contains(hex))
            seleccionColores.Add(hex);

        mensajeOk = $"Color {hex} añadido correctamente.";
    }

    private async Task OnPalabraCreada(string palabra)
    {
        await CargarCombosAsync();

        if (!seleccionPalabras.Contains(palabra))
            seleccionPalabras.Add(palabra);

        mensajeOk = $"Palabra \"{palabra}\" añadida correctamente.";
    }

    private async Task GuardarProyecto(bool empezarPrueba)
    {
        if (busy) return;

        mensajeOk = null;
        mensajeError = null;

        LimpiarErroresFormulario();

        var valido = true;

        if (string.IsNullOrWhiteSpace(proyecto.Nombre))
        {
            errorNombre = "El nombre del proyecto es obligatorio.";
            valido = false;
        }

        if (string.IsNullOrWhiteSpace(proyecto.Proveedor))
        {
            errorProveedor = "El fabricante/marca es obligatorio.";
            valido = false;
        }

        if (seleccionPalabras == null || seleccionPalabras.Count == 0)
        {
            errorPalabras = "Selecciona al menos una palabra.";
            valido = false;
        }

        if (seleccionColores == null || seleccionColores.Count == 0)
        {
            errorColores = "Selecciona al menos un color.";
            valido = false;
        }

        if (seleccionFragancias == null || seleccionFragancias.Count == 0)
        {
            errorFragancias = "Selecciona al menos una fragancia.";
            valido = false;
        }

        if (!valido)
        {
            mensajeError = "Revisa los campos marcados en rojo.";
            return;
        }

        busy = true;

        try
        {
            var emailActual = UserSession.Email;
            if (string.IsNullOrWhiteSpace(emailActual))
            {
                mensajeError = "No se ha podido obtener el usuario actual. Vuelve a iniciar sesión.";
                return;
            }

            proyecto.CreadoPor = emailActual.Trim().ToLower();

            string codigoProyecto;

            if (!EsEdicion)
            {
                codigoProyecto = await EProyecto.CrearProyectoAsync(proyecto);
                proyecto.Codigo = codigoProyecto;

                numParticipantesProyecto = 0;
            }
            else
            {
                codigoProyecto = CodigoProyecto!;
                proyecto.Codigo = codigoProyecto;

                await EProyecto.ActualizarProyectoAsync(proyecto);

                await ProyectoPalabraService.EliminarPorProyectoAsync(codigoProyecto);
                await ProyectoColorService.EliminarPorProyectoAsync(codigoProyecto);
                await EProyectoFragancia.EliminarPorProyectoAsync(codigoProyecto);

                var pruebasProyecto = await EPrueba.ListarPruebasPorProyectoAsync(codigoProyecto);
                numParticipantesProyecto = pruebasProyecto?.Count ?? 0;
            }

            foreach (var palabra in seleccionPalabras)
                await ProyectoPalabraService.CrearProyectoPalabraAsync(codigoProyecto, palabra);

            foreach (var hex in seleccionColores)
                await ProyectoColorService.CrearProyectoColorAsync(codigoProyecto, hex);

            foreach (var codFragancia in seleccionFragancias)
                await EProyectoFragancia.CrearProyectoFraganciaAsync(codigoProyecto, codFragancia);

            mensajeOk = EsEdicion
                ? "Proyecto actualizado correctamente."
                : "Proyecto guardado correctamente.";

            if (empezarPrueba)
                Nav.NavigateTo($"/investigador/pruebas/{codigoProyecto}");
            else
                Nav.NavigateTo("/investProyecto");
        }
        catch (PostgresException ex)
        {
            mensajeError = ex.MessageText;
        }
        catch (Exception ex)
        {
            mensajeError = "Error inesperado al guardar el proyecto: " + ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    private void LimpiarErroresFormulario()
    {
        errorNombre = null;
        errorProveedor = null;
        errorDescripcion = null;
        errorPalabras = null;
        errorColores = null;
        errorFragancias = null;
    }

    private void Cancelar()
    {
        Nav.NavigateTo("/investProyecto");
    }
}
