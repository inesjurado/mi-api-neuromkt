@page "/nuevoProyecto"
@page "/nuevoProyecto/{CodigoProyecto}"
@using NeuromktApi.Models
@using NeuromktApi.Services
@using Npgsql
@using System.Linq

@inject UserSession UserSession
@inject IEProyectoFragancia EProyectoFragancia
@inject IEPrueba EPrueba
@inject IEProyecto EProyecto
@inject IEColor EColor
@inject IEPalabra EPalabra
@inject IEFragancia EFragancia    
@inject IEParticipante EParticipante 
@inject IEProyectoPalabra ProyectoPalabraService
@inject IEProyectoColor ProyectoColorService
@inject IJSRuntime JS
@inject NavigationManager Nav

<RadzenCard Class="nf-page" Style="border:none; box-shadow:none;">

    <!-- Cabecera -->
    <div class="nf-header">
        <RadzenCard Class="nf-title-card">
            <div class="nf-title-text">
                @(EsEdicion ? "EDITAR PROYECTO" : "NUEVO PROYECTO")
            </div>
        </RadzenCard>
    </div>

    <RadzenCard Class="nf-table-card" Style="margin-top:2rem; max-width:900px; margin-left:auto; margin-right:auto;">

        @if (!string.IsNullOrEmpty(mensajeOk))
        {
            <RadzenAlert Severity="AlertSeverity.Success"
                         Style="margin-bottom:0.75rem;">
                @mensajeOk
            </RadzenAlert>
        }

        @if (!string.IsNullOrEmpty(mensajeError))
        {
            <RadzenAlert Severity="AlertSeverity.Error"
                         Style="margin-bottom:0.75rem;">
                @mensajeError
            </RadzenAlert>
        }

        <div class="nf-form-vertical">

            <div class="nf-form-field">
                <label class="nf-label">Nombre del proyecto:</label>
                <RadzenTextBox @bind-Value="proyecto.Nombre"
                               Style="width:100%;" />
            </div>

            <div class="nf-form-field">
                <label class="nf-label">Fabricante / marca:</label>
                <RadzenTextBox @bind-Value="proyecto.Proveedor"
                               Style="width:100%;" />
            </div>

            <div class="nf-form-field">
                <label class="nf-label">Descripción breve:</label>
                <RadzenTextArea @bind-Value="proyecto.Descripcion"
                                Rows="3"
                                Style="width:100%;" />
            </div>

            <hr />

            <!-- Palabras -->
            <div class="nf-form-field">
                <label class="nf-label">Palabras:</label>
                <div style="display:flex; align-items:center; gap:0.75rem;">
                    <RadzenDropDown Data="@palabras"
                                    TextProperty="Palabra"
                                    ValueProperty="Palabra"
                                    @bind-Value="seleccionPalabras"
                                    Multiple="true"
                                    Style="flex:1;"
                                    Placeholder="Selecciona las palabras a usar" />

                    <RadzenButton Icon="add_circle"
                                  Text="Añadir"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Click="@AbrirNuevaPalabraDesdeProyecto" />
                </div>
            </div>

            <!-- Colores -->
            <div class="nf-form-field">
                <label class="nf-label">Colores:</label>
                <div style="display:flex; align-items:center; gap:0.75rem;">
                    <RadzenDropDown Data="@colores"
                                    @bind-Value="seleccionColores"
                                    Multiple="true"
                                    Style="flex:1;"
                                    Placeholder="Selecciona los colores a usar"
                                    TextProperty="Hex"
                                    ValueProperty="Hex">

                        <!-- Cada opción en la lista -->
                        <Template Context="c">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div style="width:18px; height:18px; border-radius:4px; background-color:@c.Hex;"></div>
                                @c.Hex
                            </div>
                        </Template>

                    </RadzenDropDown>

                    <RadzenButton Icon="add_circle"
                                  Text="Añadir"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Click="@AbrirNuevoColorDesdeProyecto" />
                </div>
            </div>

            <!-- Fragancias -->
            <div class="nf-form-field">
                <label class="nf-label">Fragancia(s):</label>
                <div style="display:flex; align-items:center; gap:0.75rem;">
                    <RadzenDropDown Data="@fragancias"
                                    TextProperty="Nombre"
                                    ValueProperty="Codigo"    
                                    @bind-Value="seleccionFragancias"
                                    Multiple="true"
                                    Style="flex:1;"
                                    Placeholder="Selecciona las fragancias del proyecto" />

                    <RadzenButton Icon="add_circle"
                                  Text="Añadir"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Click="@AbrirNuevaFraganciaDesdeProyecto" />
                </div>
            </div>

            <hr />

            <!-- Participantes -->
            <div class="nf-form-field">
                <label class="nf-label">Participantes:</label>
                <div style="display:flex; align-items:center; gap:0.75rem;">
                    <RadzenDropDown Data="@participantes"
                                    TextProperty="Email"     
                                    ValueProperty="Email"    
                                    @bind-Value="seleccionParticipantes"
                                    Multiple="true"
                                    Style="width:100%;"
                                    Placeholder="Selecciona los participantes que harán la prueba" />

                    <RadzenButton Icon="add_circle"
                                  Text="Añadir"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Click="@AbrirNuevoParticipanteDesdeProyecto" />
                </div>
            </div>

            <div class="nf-form-field">
                <label class="nf-label">
                    Número de participantes del proyecto:
                    @((seleccionParticipantes?.Count ?? 0)) (automático)
                </label>
            </div>

            <div class="nf-form-actions" style="margin-top:1.5rem; display:flex; flex-wrap:wrap; gap:0.75rem;">

                <RadzenButton Text="EMPEZAR"
                              ButtonStyle="ButtonStyle.Primary"
                              Disabled="@busy"
                              Click="@(() => GuardarProyecto(true))" />

                <RadzenButton Text="Guardar"
                              Icon="save"
                              ButtonStyle="ButtonStyle.Secondary"
                              Disabled="@busy"
                              Click="@(() => GuardarProyecto(false))" />

                <RadzenButton Text="Cancelar"
                              ButtonStyle="ButtonStyle.Light"
                              Click="@Cancelar" />
            </div>

        </div>

    </RadzenCard>

</RadzenCard>

<!-- POPUP NUEVA FRAGANCIA (reutilizable) -->
<NuevaFragancia Visible="@dialogoFraganciaVisible"
                VisibleChanged="@(v => dialogoFraganciaVisible = v)"
                EsEdicion="false"
                OnGuardado="@OnFraganciaCreada" />

<!-- POPUP NUEVO PARTICIPANTE (reutilizable) -->
<NuevoParticipante Visible="@dialogoParticipanteVisible"
                   VisibleChanged="@(v => dialogoParticipanteVisible = v)"
                   EsEdicion="false"
                   OnGuardado="@OnParticipanteCreado" />

<!-- POPUP NUEVO COLOR (ColorForm reutilizable) -->
<ColorForm Visible="@dialogColorVisible"
           VisibleChanged="@(v => dialogColorVisible = v)"
           EsEdicion="false"
           ColorActual="null"
           OnGuardado="@OnColorCreado" />

<!-- POPUP NUEVA PALABRA (PalabraForm reutilizable) -->
<PalabraForm Visible="@dialogPalabraVisible"
             VisibleChanged="@(v => dialogPalabraVisible = v)"
             EsEdicion="false"
             PalabraOriginal="null"
             OnGuardado="@OnPalabraCreada" />

@code {
    private ProyectoModel proyecto = new ProyectoModel();
    [Parameter] public string? CodigoProyecto { get; set; }
    private bool EsEdicion => !string.IsNullOrWhiteSpace(CodigoProyecto);

    private List<PalabraModel> palabras = new();
    private List<ColorModel> colores = new();
    private List<FraganciaModel> fragancias = new();
    private List<ParticipanteModel> participantes = new();

    private IList<string> seleccionPalabras = new List<string>();
    private IList<string> seleccionColores = new List<string>();
    private IList<string> seleccionFragancias = new List<string>();
    private IList<string> seleccionParticipantes = new List<string>(); 

    private bool busy = false;
    private string? mensajeOk;
    private string? mensajeError;

    // popups
    private bool dialogoFraganciaVisible = false;
    private bool dialogoParticipanteVisible = false;

    // popups de color / palabra
    private bool dialogColorVisible = false;
    private bool dialogPalabraVisible = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarCombosAsync();
        if (EsEdicion)
        {
            await CargarProyectoExistenteAsync();
        }
    }

    private async Task CargarProyectoExistenteAsync()
    {
        try
        {
            // 1) Datos básicos del proyecto
            proyecto = await EProyecto.ObtenerProyectoAsync(CodigoProyecto!);

            // 2) Palabras del proyecto
            var palabrasProyecto = await ProyectoPalabraService.ListarPalabrasPorProyectoAsync(CodigoProyecto!);
            seleccionPalabras = palabrasProyecto
                .Select(p => p.Palabra)
                .ToList();

            // 3) Colores del proyecto
            var coloresProyecto = await ProyectoColorService.ListarColoresPorProyectoAsync(CodigoProyecto!);
            seleccionColores = coloresProyecto
                .Select(c => c.ColorHex)
                .ToList();

            // 4) Fragancias del proyecto
            var fraganciasProyecto = await EProyectoFragancia.ListarFraganciasPorProyectoAsync(CodigoProyecto!);
            seleccionFragancias = fraganciasProyecto
                .Select(f => f.FraganciaCodigo)
                .ToList();

            // 5) Participantes del proyecto (pruebas)
            var pruebasProyecto = await EPrueba.ListarPruebasPorProyectoAsync(CodigoProyecto!);
            seleccionParticipantes = pruebasProyecto
                .Select(pr => pr.ParticipanteEmail)
                .ToList();
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando el proyecto: " + ex.Message;
        }
    }

    private async Task CargarCombosAsync()
    {
        try
        {
            palabras      = await EPalabra.ListarPalabrasAsync();
            colores       = await EColor.ListarColoresAsync();
            fragancias    = await EFragancia.ListarFraganciasAsync();
            participantes = await EParticipante.ListarParticipantesAsync();
        }
        catch (Exception ex)
        {
            mensajeError = "Error cargando datos del formulario: " + ex.Message;
        }
    }

    // === Abrir popups desde esta vista ===
    private void AbrirNuevaFraganciaDesdeProyecto()
    {
        dialogoFraganciaVisible = true;
    }

    private void AbrirNuevoParticipanteDesdeProyecto()
    {
        dialogoParticipanteVisible = true;
    }

    private void AbrirNuevoColorDesdeProyecto()
    {
        dialogColorVisible = true;
    }

    private void AbrirNuevaPalabraDesdeProyecto()
    {
        dialogPalabraVisible = true;
    }

    // === Callbacks desde los popups ===
    private async Task OnFraganciaCreada(string codigo)
    {
        await CargarCombosAsync();

        var nueva = fragancias.FirstOrDefault(f => f.Codigo == codigo);
        if (nueva != null)
        {
            if (!seleccionFragancias.Contains(codigo))
                seleccionFragancias.Add(codigo);
        }

        mensajeOk = $"Fragancia \"{nueva?.Nombre ?? codigo}\" creada correctamente.";
    }

    private async Task OnParticipanteCreado(string email)
    {
        await CargarCombosAsync();

        if (!seleccionParticipantes.Contains(email))
            seleccionParticipantes.Add(email);

        mensajeOk = $"Participante \"{email}\" creado correctamente.";
    }

    private async Task OnColorCreado(string hex)
    {
        await CargarCombosAsync();

        if (!seleccionColores.Contains(hex))
            seleccionColores.Add(hex);

        mensajeOk = $"Color {hex} añadido correctamente.";
    }

    private async Task OnPalabraCreada(string palabra)
    {
        await CargarCombosAsync();

        if (!seleccionPalabras.Contains(palabra))
            seleccionPalabras.Add(palabra);

        mensajeOk = $"Palabra \"{palabra}\" añadida correctamente.";
    }

    private async Task GuardarProyecto(bool empezarPrueba)
    {
        if (busy) return;

        mensajeOk = null;
        mensajeError = null;

        if (string.IsNullOrWhiteSpace(proyecto.Nombre))
        {
            mensajeError = "El nombre del proyecto es obligatorio.";
            return;
        }

        if (string.IsNullOrWhiteSpace(proyecto.Proveedor))
        {
            mensajeError = "El fabricante/marca es obligatorio.";
            return;
        }

        busy = true;

        try
        {
            var emailActual = UserSession.Email;
            if (string.IsNullOrWhiteSpace(emailActual))
            {
                mensajeError = "No se ha podido obtener el usuario actual. Vuelve a iniciar sesión.";
                busy = false;
                return;
            }
            proyecto.CreadoPor = emailActual;

            string codigoProyecto;

            if (!EsEdicion)
            {
                codigoProyecto = await EProyecto.CrearProyectoAsync(proyecto);
                proyecto.Codigo = codigoProyecto;
            }
            else
            {
                codigoProyecto = CodigoProyecto!;
                proyecto.Codigo = codigoProyecto;

                await EProyecto.ActualizarProyectoAsync(proyecto);

                await ProyectoPalabraService.EliminarPorProyectoAsync(codigoProyecto);
                await ProyectoColorService.EliminarPorProyectoAsync(codigoProyecto);
                await EProyectoFragancia.EliminarPorProyectoAsync(codigoProyecto);
                await EPrueba.EliminarPruebasPorProyectoAsync(codigoProyecto);
            }

            // PALABRAS
            if (seleccionPalabras?.Count > 0)
            {
                foreach (var palabra in seleccionPalabras)
                {
                    await ProyectoPalabraService.CrearProyectoPalabraAsync(codigoProyecto, palabra);
                }
            }

            // COLORES
            if (seleccionColores?.Count > 0)
            {
                foreach (var hex in seleccionColores)
                {
                    await ProyectoColorService.CrearProyectoColorAsync(codigoProyecto, hex);
                }
            }

            // FRAGANCIAS
            if (seleccionFragancias?.Count > 0)
            {
                foreach (var codFragancia in seleccionFragancias)
                {
                    await EProyectoFragancia.CrearProyectoFraganciaAsync(codigoProyecto, codFragancia);
                }
            }

            // PARTICIPANTES → PRUEBAS
            if (seleccionParticipantes?.Count > 0)
            {
                foreach (var emailParticipante in seleccionParticipantes)
                {
                    await EPrueba.CrearPruebaAsync(codigoProyecto, emailParticipante);
                }
            }

            mensajeOk = EsEdicion
                ? "Proyecto actualizado correctamente."
                : "Proyecto guardado correctamente.";

            if (empezarPrueba)
            {
                Nav.NavigateTo($"/investigador/pruebas/{codigoProyecto}");
            }
            else
            {
                Nav.NavigateTo("/investProyecto");
            }
        }
        catch (PostgresException ex)
        {
            mensajeError = ex.MessageText;
        }
        catch (Exception ex)
        {
            mensajeError = "Error inesperado al guardar el proyecto: " + ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    private void Cancelar()
    {
        Nav.NavigateTo("/investProyecto");
    }
}
