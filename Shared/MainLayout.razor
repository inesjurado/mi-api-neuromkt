@inherits LayoutComponentBase

@using NeuromktApi.Models
@using NeuromktApi.Services
@using NeuromktApi.Pages
@using NeuromktApi.Shared

@inject NavigationManager NavigationManager
@inject UserSession UserSession
@inject IEUsuario EUsuario

<RadzenLayout Style="min-height:100vh;">
    <RadzenSidebar @bind-Expanded="@sidebarExpanded"
                   Media="(max-width: 992px)"
                   Style="width:260px;">
        <div class="sidebar-content">
            <RadzenPanelMenu>
                @if (IsAdmin)
                {
                    <RadzenPanelMenuItem Text="Proyectos" Path="/proyectos" Icon="list" />
                    <RadzenPanelMenuItem Text="Perfiles" Path="/usuario-test" Icon="group" />
                    <RadzenPanelMenuItem Text="Configuracion" Path="/configuracion" Icon="settings" />
                }

                @if (IsInvestigador)
                {
                    <RadzenPanelMenuItem Text="Proyectos" Path="/investProyecto" Icon="assignment" />
                    <RadzenPanelMenuItem Text="Fragancias" Path="/investFragancias" Icon="science" />
                    <RadzenPanelMenuItem Text="Participantes" Path="/investParticipante" Icon="people" />
                }
            </RadzenPanelMenu>

            <div class="sidebar-footer">
                <img src="images/MACOM_BLANCO.png"
                     alt="MACOM"
                     class="sidebar-macom-logo" />

                <RadzenButton Text="Cerrar sesión"
                              Icon="logout"
                              ButtonStyle="ButtonStyle.Danger"
                              Style="width:100%;"
                              Click="@Logout" />
            </div>
        </div>
    </RadzenSidebar>

    <RadzenBody>
        <RadzenTopBar>
            <div class="nf-topbar">
                <div class="nf-topbar-left">
                    <RadzenSidebarToggle Click="@ToggleSidebar" Class="nf-topbar-toggle" />
                </div>

                <div class="nf-user-header-click"
                     style="cursor:pointer;"
                     @onclick="AbrirPopupPerfil">
                    <UserHeaderCard />
                </div>
            </div>
        </RadzenTopBar>

        <div class="p-4">
            @Body
        </div>
    </RadzenBody>
</RadzenLayout>

@if (perfilPopupVisible)
{
    <div class="nf-modal-backdrop" @onclick="CerrarPopupPerfil">
        <RadzenCard Class="nf-modal-card" @onclick:stopPropagation="true">
            <div class="nf-modal-header">
                <span>Editar perfil</span>
                <button type="button"
                        class="nf-modal-close"
                        @onclick="CerrarPopupPerfil">
                    ✕
                </button>
            </div>

            <UsuarioForm Visible="@perfilPopupVisible"
                         VisibleChanged="@OnPerfilVisibleChanged"
                         EsEdicion="true"
                         Usuario="@usuarioActual"
                         OnGuardado="@OnPerfilGuardado" />
        </RadzenCard>
    </div>
}

@code {
    private bool sidebarExpanded = true;

    private bool IsAdmin =>
        string.Equals(UserSession?.Role, "Administrador", StringComparison.OrdinalIgnoreCase);

    private bool IsInvestigador =>
        string.Equals(UserSession?.Role, "Investigador", StringComparison.OrdinalIgnoreCase);

    private bool perfilPopupVisible = false;
    private UsuarioModel? usuarioActual;
    private bool cargandoPerfil = false;

    private void ToggleSidebar() => sidebarExpanded = !sidebarExpanded;

    private void Logout()
    {
        if (UserSession is not null)
        {
            UserSession.Role = null;
            UserSession.Email = null;
        }

        NavigationManager.NavigateTo("/login", forceLoad: true);
    }

    private async Task AbrirPopupPerfil()
    {
        perfilPopupVisible = true;
        await InvokeAsync(StateHasChanged);
        await CargarUsuarioActualAsync();
    }

    private async Task CerrarPopupPerfil()
    {
        perfilPopupVisible = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnPerfilVisibleChanged(bool v)
    {
        perfilPopupVisible = v;
        await InvokeAsync(StateHasChanged);
    }

    private async Task CargarUsuarioActualAsync()
    {
        if (cargandoPerfil) return;

        var email = UserSession?.Email;
        if (string.IsNullOrWhiteSpace(email))
            return;

        cargandoPerfil = true;

        try
        {
            usuarioActual = await EUsuario.ObtenerUsuarioAsync(email.Trim().ToLower());
            await InvokeAsync(StateHasChanged);
        }
        finally
        {
            cargandoPerfil = false;
        }
    }

    private async Task OnPerfilGuardado(string email)
    {
        perfilPopupVisible = false;
        await InvokeAsync(StateHasChanged);
    }
}
