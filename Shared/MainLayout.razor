@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject UserSession UserSession
@using NeuromktApi.Models
@using NeuromktApi.Pages
@using NeuromktApi.Services
@inject IEUsuario EUsuario

<RadzenLayout Style="min-height:100vh;">
    <RadzenSidebar 
        @bind-Expanded="@sidebarExpanded"
        Media="(max-width: 992px)"
        Style="width:260px;">
        <div class="sidebar-content">
            <RadzenPanelMenu>
                @* Solo ADMIN *@
                @if (IsAdmin)
                {
                    <RadzenPanelMenuItem Text="Proyectos" Path="/proyectos" Icon="list" />
                    <RadzenPanelMenuItem Text="Perfiles" Path="/usuario-test" Icon="group" />
                    <RadzenPanelMenuItem Text="Configuracion" Path="/configuracion" Icon="settings" />
                }

                @* Solo INVESTIGADOR *@
                @if (IsInvestigador)
                {
                    <RadzenPanelMenuItem Text="Proyectos" Path="/investProyecto" Icon="assignment" />
                    <RadzenPanelMenuItem Text="Fragancias" Path="/investFragancias" Icon="science" />
                    <RadzenPanelMenuItem Text="Participantes" Path="/investParticipante" Icon="people" />
                }

            </RadzenPanelMenu>
            <div class="sidebar-footer">
                    <RadzenButton Text="Cerrar sesión"
                                Icon="logout"
                                ButtonStyle="ButtonStyle.Danger"
                                Style="width:100%;"
                                Click="@Logout" />
            </div>
        </div>
    </RadzenSidebar>

    <RadzenBody>
        <RadzenTopBar>
            <ChildContent>
                <div class="nf-topbar">
                    <div class="nf-topbar-left">
                        <RadzenSidebarToggle Click="@ToggleSidebar" Class="nf-topbar-toggle" />

                        <span class="rz-toolbar-title ml-2">
                            NEUROFRAGANCIAS (@UserSession.Role)
                        </span>
                    </div>

                    <div class="nf-user-header-click"
                             style="cursor:pointer;"
                             @onclick="EditarPerfilPropio">
                            <UserHeaderCard />
                    </div>
                </div>
            </ChildContent>
        </RadzenTopBar>

        <div class="p-4">
            @Body
        </div>
    </RadzenBody>
</RadzenLayout>

<UsuarioForm Visible="@perfilPopupVisible"
             VisibleChanged="@(v => perfilPopupVisible = v)"
             EsEdicion="true"
             Usuario="@usuarioActual"
             OnGuardado="@OnPerfilGuardado" />

@code {
    bool sidebarExpanded = true;

    bool IsAdmin => UserSession.Role == "Administrador";
    bool IsInvestigador => UserSession.Role == "Investigador";

    private bool perfilPopupVisible = false;
    private UsuarioModel? usuarioActual;
    private bool cargandoPerfil = false;


    void ToggleSidebar()
    {
        sidebarExpanded = !sidebarExpanded;
    }
    void Logout()
    {
        // Si usas UserSession para el rol, lo limpiamos
        if (UserSession is not null)
        {
            UserSession.Role = null;
        }

        // Volver al login
        NavigationManager.NavigateTo("/login", true);
    }

    private async Task EditarPerfilPropio()
    {
        if (cargandoPerfil) return;

        // Necesitamos el email del usuario actual
        if (string.IsNullOrWhiteSpace(UserSession.Email))
        {
            // si quieres, aquí podrías mandar al login
            NavigationManager.NavigateTo("/login");
            return;
        }

        cargandoPerfil = true;

        try
        {
            usuarioActual = await EUsuario.ObtenerUsuarioAsync(UserSession.Email);
            perfilPopupVisible = true;
        }
        catch (Exception)
        {
            // aquí podrías loguear algo o mostrar un mensaje global si quisieras
        }
        finally
        {
            cargandoPerfil = false;
        }
    }

    private void OnPerfilGuardado(string email)
    {
        // Si quieres, aquí podrías refrescar UserSession (rol, nombre, etc.)
        // De momento solo cerramos el popup
        perfilPopupVisible = false;
    }
}
